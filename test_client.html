<!DOCTYPE html>
<html>
<head>
    <title>GoIM WebSocket Test Client</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .section { margin: 20px 0; border: 1px solid #ccc; padding: 15px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 8px; width: 300px; }
        #log { background: #1e1e1e; color: #00ff00; padding: 15px; height: 400px; overflow-y: scroll; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>GoIM WebSocket Test Client</h1>

    <div class="section">
        <h3>连接设置</h3>
        <input type="text" id="wsUrl" value="ws://localhost:3102/sub" placeholder="WebSocket URL">
        <button onclick="connect()">连接</button>
        <button onclick="disconnect()">断开</button>
    </div>

    <div class="section">
        <h3>认证设置</h3>
        <label>MID: <input type="number" id="mid" value="12345"></label><br><br>
        <label>Key: <input type="text" id="key" value="test-key-123"></label><br><br>
        <label>Room ID: <input type="text" id="roomId" value="test://room-001"></label><br><br>
        <button onclick="sendAuth()">发送认证</button>
    </div>

    <div class="section">
        <h3>心跳</h3>
        <button onclick="sendHeartbeat()">发送心跳</button>
        <button onclick="toggleAutoHeartbeat()">自动心跳: <span id="autoStatus">关闭</span></button>
    </div>

    <div id="status" class="status disconnected">状态: 未连接</div>

    <div class="section">
        <h3>日志</h3>
        <div id="log"></div>
    </div>

    <script>
        let ws = null;
        let autoHeartbeatInterval = null;
        let seq = 1;

        function log(msg) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${msg}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(connected) {
            const status = document.getElementById('status');
            if (connected) {
                status.textContent = '状态: 已连接';
                status.className = 'status connected';
            } else {
                status.textContent = '状态: 未连接';
                status.className = 'status disconnected';
            }
        }

        function connect() {
            const url = document.getElementById('wsUrl').value;
            log(`正在连接到 ${url}...`);

            ws = new WebSocket(url);

            ws.onopen = function() {
                log('WebSocket 连接成功！');
                updateStatus(true);
            };

            ws.onmessage = function(event) {
                // Parse binary message
                const data = new DataView(event.data);
                const ver = data.getUint16(0, false);
                const op = data.getInt32(2, false);
                const seq = data.getInt32(6, false);
                const bodyLen = data.getInt32(10, false);

                let opName = 'Unknown';
                switch(op) {
                    case 2: opName = 'Heartbeat'; break;
                    case 3: opName = 'Heartbeat Reply'; break;
                    case 5: opName = 'Message'; break;
                    case 7: opName = 'Auth'; break;
                    case 8: opName = 'Auth Reply'; break;
                }

                log(`收到消息: ver=${ver}, op=${op}(${opName}), seq=${seq}, bodyLen=${bodyLen}`);

                // If there's a body, try to decode it
                if (bodyLen > 0) {
                    const body = new TextDecoder().decode(event.data.slice(14));
                    log(`Body: ${body}`);
                }
            };

            ws.onclose = function() {
                log('WebSocket 连接关闭');
                updateStatus(false);
                stopAutoHeartbeat();
            };

            ws.onerror = function(error) {
                log('WebSocket 错误: ' + error);
                updateStatus(false);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function encodeMessage(ver, op, seq, body) {
            const bodyBytes = body ? new TextEncoder().encode(body) : new Uint8Array(0);
            const bodyLen = bodyBytes.length;

            const buffer = new ArrayBuffer(14 + bodyLen);
            const view = new DataView(buffer);

            view.setUint16(0, ver, false);     // protocol version (big endian)
            view.setInt32(2, op, false);       // operation (big endian)
            view.setInt32(6, seq, false);      // sequence (big endian)
            view.setInt32(10, bodyLen, false); // body length (big endian)

            if (bodyLen > 0) {
                new Uint8Array(buffer, 14).set(bodyBytes);
            }

            return buffer;
        }

        function sendAuth() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('错误: WebSocket 未连接');
                return;
            }

            const mid = document.getElementById('mid').value;
            const key = document.getElementById('key').value;
            const roomId = document.getElementById('roomId').value;

            const token = JSON.stringify({
                mid: parseInt(mid),
                key: key,
                room_id: roomId,
                platform: "web",
                accepts: [1000, 1001, 1002]
            });

            const msg = encodeMessage(102, 7, seq++, token);
            ws.send(msg);
            log(`发送认证: ${token}`);
        }

        function sendHeartbeat() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('错误: WebSocket 未连接');
                return;
            }

            const msg = encodeMessage(102, 2, seq++, null);
            ws.send(msg);
            log('发送心跳');
        }

        function toggleAutoHeartbeat() {
            if (autoHeartbeatInterval) {
                stopAutoHeartbeat();
            } else {
                autoHeartbeatInterval = setInterval(sendHeartbeat, 30000);
                document.getElementById('autoStatus').textContent = '开启';
                log('自动心跳已开启 (每30秒)');
            }
        }

        function stopAutoHeartbeat() {
            if (autoHeartbeatInterval) {
                clearInterval(autoHeartbeatInterval);
                autoHeartbeatInterval = null;
                document.getElementById('autoStatus').textContent = '关闭';
                log('自动心跳已关闭');
            }
        }
    </script>
</body>
</html>
