import{p as Ee,r as C,q as lt,s as Ce,v as ye,u as Ve,x as oe,y as Pe,d as he,z as Q,c as F,o as g,A as K,B as P,F as de,g as me,C as _e,e,b as n,w as s,m as G,t as N,f as b,j as U,_ as we,D as Te,G as Be,i as Je,E as L,H as fe,I as Ye,J as Ze,K as Ne,L as Me,M as ge,N as Ke,O as Qe,P as Ue,Q as it,R as ut,S as ct,T as dt,U as mt,V as je,W as Xe,X as xe,Y as _t,Z as Ge,$ as vt,k as pt,a0 as ft,a1 as gt,a2 as yt,a3 as ht,h as wt}from"./index-RsWyZ14U.js";const Fe=Ee("chat",()=>{const y=C([]),V=C([]),a=C(null),c=C(new Map);C(new Map);const T=async()=>{var h;const S=await lt.getList();S.code===0&&(y.value=((h=S.data)==null?void 0:h.conversations)||[])};return{conversations:y,friends:V,currentSession:a,sessions:c,loadConversations:T,loadFriends:async()=>{var h;const S=await Ce.getFriends();S.code===0&&(V.value=((h=S.data)==null?void 0:h.friends)||[])},openChat:async(S,h,l,o)=>{var $;const i=`${S}:${h}`;if(!c.value.has(i)){const p=await ye.getHistory({conversation_id:S,conversation_type:h,limit:50}),z={id:i,targetId:S,targetType:h===1?"user":"group",name:l||`Chat ${S}`,avatar:o,unreadCount:0,messages:(($=p==null?void 0:p.data)==null?void 0:$.messages)||[]};c.value.set(i,z)}a.value=c.value.get(i);const f=y.value.find(p=>p.target_id===S&&p.conversation_type===h);if(f&&f.unread_count>0){const p=c.value.get(i);if(p&&p.messages.length>0){const z=p.messages[p.messages.length-1];await ye.markRead({conversation_id:S,conversation_type:h,msg_id:z.id}),f.unread_count=0}}},sendMessage:async(S,h=1)=>{var f,$,p,z,j,se;if(!a.value)return!1;const o=((f=Ve().currentUser)==null?void 0:f.id)||0,i=await ye.send({to_user_id:a.value.targetType==="user"?a.value.targetId:void 0,to_group_id:a.value.targetType==="group"?a.value.targetId:void 0,conversation_type:a.value.targetType==="user"?1:2,msg_type:h,content:S});if(i.code===0){const ae={id:Date.now(),msg_id:($=i.data)==null?void 0:$.msg_id,from_user_id:o,conversation_id:(p=i.data)==null?void 0:p.conversation_id,conversation_type:(z=i.data)==null?void 0:z.conversation_type,msg_type:h,content:S,seq:(j=i.data)==null?void 0:j.seq,created_at:(se=i.data)==null?void 0:se.created_at};return a.value.messages.push(ae),!0}return!1},addMessage:S=>{const h=`${S.conversation_id}:${S.conversation_type}`;let l=c.value.get(h);l||(l={id:h,targetId:S.conversation_id,targetType:S.conversation_type===1?"user":"group",name:`Chat ${S.conversation_id}`,unreadCount:0,messages:[]},c.value.set(h,l)),l.messages.push(S),T()},getSessionKey:S=>{var f;const l=((f=Ve().currentUser)==null?void 0:f.id)||0,o=Math.min(l,S),i=Math.max(l,S);return`${o*1e9+i}:1`}}}),Ae=Ee("group",()=>{const y=C([]),V=C(null),a=C([]),c=C(!1),T=async()=>{var o;c.value=!0;try{const i=await oe.getList();if(i.code===0){const f=((o=i.data)==null?void 0:o.groups)||[];y.value=f.filter($=>$!=null&&$.id!=null)}else y.value=[]}catch(i){throw console.error("Failed to load groups:",i),y.value=[],i}finally{c.value=!1}},_=async o=>{c.value=!0;try{const i=await oe.create(o);if(i.code===0){const f={id:i.data.group_id,group_no:i.data.group_no,name:i.data.name,owner_id:i.data.owner_id,max_members:i.data.max_members,join_type:1,mute_all:0};return y.value.push(f),f}return null}catch(i){throw console.error("Failed to create group:",i),i}finally{c.value=!1}},x=async o=>{V.value=o,await A(o.id)},A=async o=>{var i;try{const f=await oe.getMembers(o);if(f.code===0){const $=((i=f.data)==null?void 0:i.members)||[];a.value=$.filter(p=>p!=null&&p.id!=null)}else a.value=[]}catch(f){throw console.error("Failed to load members:",f),a.value=[],f}};return{groups:y,currentGroup:V,members:a,loading:c,loadGroups:T,createGroup:_,setCurrentGroup:x,loadMembers:A,joinGroup:async(o,i)=>{try{return(await oe.join(o,i)).code===0?(await T(),!0):!1}catch(f){throw console.error("Failed to join group:",f),f}},leaveGroup:async o=>{var i;try{return(await oe.leave(o)).code===0?(y.value=y.value.filter($=>$.id!==o),((i=V.value)==null?void 0:i.id)===o&&(V.value=null,a.value=[]),!0):!1}catch(f){throw console.error("Failed to leave group:",f),f}},sendMessage:async(o,i)=>{try{return(await ye.send({to_group_id:o,conversation_type:2,msg_type:1,content:JSON.stringify({text:i})})).code===0}catch(f){throw console.error("Failed to send message:",f),f}},getGroupById:o=>y.value.find(i=>i.id===o),clearCurrentGroup:()=>{V.value=null,a.value=[]}}}),et=Ee("ai",()=>{const y=C([]),V=C(null),a=C(new Map),c=C(!1),T=C(!1),_=async()=>{try{const o=await Pe.getBots();o.code===0&&(y.value=o.data.bots||[])}catch(o){throw console.error("Failed to load AI bots:",o),o}},x=o=>a.value.get(o)||[],A=o=>{V.value=o,a.value.has(o.id)||a.value.set(o.id,[])},v=async(o,i)=>{if(!i.trim())return null;T.value=!0;const f={role:"user",content:i,timestamp:Date.now()},$=a.value.get(o)||[];$.push(f),a.value.set(o,$);try{const p=await Pe.sendMessage({bot_id:o,message:i});if(p.code===0){const z={role:"assistant",content:p.data.reply,timestamp:Date.now()};return $.push(z),p.data.reply}return null}catch(p){throw console.error("Failed to send AI message:",p),p}finally{T.value=!1}},k=o=>{a.value.delete(o)},S=()=>{a.value.clear()},h=C([{id:9001,name:"智能助手",personality:"assistant",role:"assistant",tone:"friendly",is_default:!0},{id:9002,name:"聊天伙伴",personality:"companion",role:"companion",tone:"casual",is_default:!0},{id:9003,name:"学习导师",personality:"tutor",role:"tutor",tone:"professional",is_default:!0},{id:9004,name:"创意助手",personality:"creative",role:"creative",tone:"imaginative",is_default:!0}]);return{bots:y,currentBot:V,messages:a,loading:c,sending:T,defaultBots:h,loadBots:_,getBotMessages:x,setCurrentBot:A,sendMessage:v,clearMessages:k,clearAllMessages:S,getBotById:o=>y.value.find(i=>i.id===o)}}),tt=2,kt=3,St=5,st=7,bt=8,ze=102,De=16;function Ie(y,V,a,c){const T=c?new TextEncoder().encode(c):new Uint8Array(0),_=T.length,x=De+_,A=new ArrayBuffer(x),v=new DataView(A),k=new Uint8Array(A);return v.setUint32(0,x,!1),v.setUint16(4,De,!1),v.setUint16(6,y,!1),v.setUint32(8,V,!1),v.setUint32(12,a,!1),_>0&&k.set(T,De),A}function Ct(y){const V=new DataView(y),a=V.getUint32(0,!1),c=V.getUint16(4,!1),T=V.getUint16(6,!1),_=V.getUint32(8,!1),x=V.getUint32(12,!1),A=a-c;let v;if(A>0){const k=new Uint8Array(y,c,A);v=new TextDecoder().decode(k)}return{ver:T,op:_,seq:x,body:v}}function $t(y){switch(y){case tt:return"Heartbeat";case kt:return"Heartbeat Reply";case St:return"Message";case st:return"Auth";case bt:return"Auth Reply";default:return`Unknown(${y})`}}function Mt(y){const V=C("disconnected"),a=C(null),c=C([]);let T=1,_=null,x=null;const A=(f,$)=>{if(!a.value||a.value.readyState!==WebSocket.OPEN)return;const p=JSON.stringify({mid:$,key:`user_${$}`,room_id:"",platform:"web",accepts:[1001,1002,1003]}),z=Ie(ze,st,T++,p);a.value.send(z),console.log("[WS] Auth sent")},v=()=>{if(!a.value||a.value.readyState!==WebSocket.OPEN)return;const f=Ie(ze,tt,T++);a.value.send(f)},k=()=>{S(),_=window.setInterval(v,3e4)},S=()=>{_&&(clearInterval(_),_=null)},h=(f,$)=>{var p;if(((p=a.value)==null?void 0:p.readyState)!==WebSocket.OPEN){V.value="connecting";try{a.value=new WebSocket(y),a.value.binaryType="arraybuffer",a.value.onopen=()=>{console.log("[WS] Connected"),V.value="connected",A(f,$),k()},a.value.onmessage=z=>{const j=Ct(z.data);if(console.log("[WS] Received:",$t(j.op),j.seq,j.body),j.op===8)console.log("[WS] Auth success");else if(j.body)try{const se=JSON.parse(j.body);c.value.push(se)}catch{}},a.value.onclose=()=>{console.log("[WS] Disconnected"),V.value="disconnected",S(),x=window.setTimeout(()=>h(f,$),5e3)},a.value.onerror=z=>{console.error("[WS] Error:",z),V.value="error"}}catch(z){console.error("[WS] Connection error:",z),V.value="error"}}};return{status:V,messages:c,connect:h,disconnect:()=>{x&&(clearTimeout(x),x=null),S(),a.value&&(a.value.close(),a.value=null),V.value="disconnected"},send:(f,$)=>{if(!a.value||a.value.readyState!==WebSocket.OPEN)return console.error("[WS] Not connected"),!1;const p=Ie(ze,f,T++,$);return a.value.send(p),!0},sendHeartbeat:v,clearMessages:()=>{c.value=[]}}}const re=y=>y?typeof y=="string"?y:typeof y=="object"&&"String"in y?y.Valid?y.String:"":String(y):"",Tt={class:"conversation-list"},xt=["onClick"],Vt={class:"item-content"},Bt={class:"item-top"},Ut={class:"item-name"},Nt={class:"item-time"},Ft={class:"item-bottom"},At={class:"item-preview"},Gt=he({__name:"ConversationList",emits:["select"],setup(y,{emit:V}){const a=V,c=Fe(),T=Ae(),_=Q(()=>c.currentSession?`${c.currentSession.targetId}:${c.currentSession.targetType==="group"?2:1}`:""),x=l=>{var i,f;const o=re((i=l.target_user)==null?void 0:i.nickname);if(o)return o;if(l.conversation_type===1){const $=c.friends.find(p=>{var z;return((z=p.friend_user)==null?void 0:z.id)===l.target_id||p.friend_id===l.target_id});if($)return $.remark||re((f=$.friend_user)==null?void 0:f.nickname)||`User ${l.target_id}`}if(l.conversation_type===2){const $=T.getGroupById(l.target_id);return $?$.name:`Group ${l.target_id}`}return`User ${l.target_id}`},A=l=>{var i,f;const o=re((i=l.target_user)==null?void 0:i.avatar);if(o)return o;if(l.conversation_type===1){const $=c.friends.find(p=>{var z;return((z=p.friend_user)==null?void 0:z.id)===l.target_id||p.friend_id===l.target_id});if($)return re((f=$.friend_user)==null?void 0:f.avatar)}if(l.conversation_type===2){const $=T.getGroupById(l.target_id);if($)return re($.avatar)}return""},v=l=>{const o=re(l.last_msg_content);if(!o)return"暂无消息";try{return JSON.parse(o).text||o}catch{return o}},k=l=>{if(!l)return"";const o=new Date(l);if(isNaN(o.getTime())){if(typeof l=="string"&&!isNaN(Number(l))){const i=Number(l),f=new Date(i<1e10?i*1e3:i);if(!isNaN(f.getTime()))return S(f)}return""}return S(o)},S=l=>{const o=new Date;return l.getDate()===o.getDate()&&l.getMonth()===o.getMonth()&&l.getFullYear()===o.getFullYear()?l.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):l.toLocaleDateString("zh-CN",{month:"numeric",day:"numeric"})},h=l=>{a("select",l)};return(l,o)=>{const i=b("el-avatar"),f=b("el-badge"),$=b("el-empty");return g(),F("div",Tt,[(g(!0),F(de,null,me(U(c).conversations,p=>(g(),F("div",{key:`${p.target_id}:${p.conversation_type}`,class:_e(["list-item",{active:_.value===`${p.target_id}:${p.conversation_type}`}]),onClick:z=>h(p)},[e(i,{size:48,src:A(p),shape:"square",class:"item-avatar"},{default:s(()=>{var z;return[G(N(((z=x(p))==null?void 0:z[0])||"?"),1)]}),_:2},1032,["src"]),n("div",Vt,[n("div",Bt,[n("span",Ut,N(x(p)),1),n("span",Nt,N(k(p.last_msg_time)),1)]),n("div",Ft,[n("span",At,N(v(p)),1),p.unread_count>0?(g(),K(f,{key:0,value:p.unread_count>99?"99+":p.unread_count,class:"unread-badge"},null,8,["value"])):P("",!0)])])],10,xt))),128)),U(c).conversations.length===0?(g(),K($,{key:0,description:"暂无消息","image-size":60})):P("",!0)])}}}),zt=we(Gt,[["__scopeId","data-v-2695438a"]]),Dt={class:"friend-manager-container"},It={class:"friend-list-content"},Et={class:"list-header"},Lt={class:"friend-items"},Rt=["onClick"],qt={class:"friend-info"},Ot={class:"friend-name"},Wt={class:"friend-meta"},Ht={key:0,class:"friend-nickname"},Pt={class:"friend-group"},Kt={class:"requests-content"},jt={class:"request-items"},Jt={class:"request-info"},Yt={class:"request-name"},Zt={key:0,class:"request-message"},Qt={class:"request-time"},Xt={class:"request-actions"},es={class:"add-friend-content"},ts={key:0,class:"search-results"},ss={class:"user-info"},ns={class:"user-name"},as={class:"user-username"},os={class:"target-user"},rs=he({__name:"FriendManager",setup(y){const V=Fe(),a=C("list"),c=C(""),T=C({keyword:""}),_=C([]),x=C(!1),A=C([]),v=C(!1),k=C({remark:"",groupName:""}),S=C(null),h=C(!1),l=C({message:""}),o=C(null),i=Q(()=>{if(!c.value)return V.friends;const B=c.value.toLowerCase();return V.friends.filter(d=>{var I,le;const q=re((I=d.friend_user)==null?void 0:I.nickname).toLowerCase(),J=((le=d.remark)==null?void 0:le.toLowerCase())||"";return q.includes(B)||J.includes(B)})}),f=B=>re(B==null?void 0:B.nickname),$=B=>{const d=new Date(B),J=new Date().getTime()-d.getTime();return J<6e4?"刚刚":J<36e5?`${Math.floor(J/6e4)} 分钟前`:J<864e5?`${Math.floor(J/36e5)} 小时前`:J<6048e5?`${Math.floor(J/864e5)} 天前`:d.toLocaleDateString("zh-CN")},p=()=>{},z=B=>{var q;const d=((q=B.friend_user)==null?void 0:q.id)||B.friend_id;V.openChat(d,1,B.remark||f(B.friend_user)||B.remark)},j=async(B,d)=>{var q;switch(B){case"chat":z(d);break;case"remark":S.value=d,k.value={remark:d.remark||((q=d.friend_user)==null?void 0:q.nickname)||"",groupName:d.group_name||""},v.value=!0;break;case"delete":await ae(d);break}},se=async()=>{if(S.value)try{L.success("备注已更新"),v.value=!1,await V.loadFriends()}catch(B){L.error(B.message||"更新失败")}},ae=async B=>{var d;try{await fe.confirm(`确定要删除好友 "${B.remark||((d=B.friend_user)==null?void 0:d.nickname)}" 吗？`,"删除好友",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await Ce.deleteFriend(B.friend_id)).code===0&&(L.success("已删除好友"),await V.loadFriends())}catch(q){q!=="cancel"&&L.error(q.message||"删除失败")}},ie=async()=>{if(T.value.keyword.trim()){x.value=!0;try{const B=await Ye.searchUsers(T.value.keyword);B.code===0&&(_.value=B.data.users||[])}catch(B){L.error(B.message||"搜索失败")}}},M=B=>{o.value=B,l.value.message="",h.value=!0},R=async()=>{if(o.value)try{(await Ce.sendRequest({to_user_id:o.value.id,message:l.value.message})).code===0&&(L.success("好友请求已发送"),h.value=!1,_.value=[])}catch(B){L.error(B.message||"发送失败")}},ne=async(B,d)=>{try{(await(d==="accept"?Ce.acceptRequest:Ce.rejectRequest)(B)).code===0&&(L.success(d==="accept"?"已接受好友请求":"已拒绝好友请求"),await ue(),d==="accept"&&await V.loadFriends())}catch(q){L.error(q.message||"操作失败")}},ue=async()=>{try{const B=await Ce.getRequests();B.code===0&&(A.value=(B.data.requests||[]).filter(d=>d.status===1))}catch(B){console.error("Failed to load friend requests:",B)}};return Te(async()=>{await V.loadFriends(),await ue()}),(B,d)=>{const q=b("el-input"),J=b("el-avatar"),I=b("MoreFilled"),le=b("el-icon"),Y=b("el-button"),pe=b("el-dropdown-item"),$e=b("el-dropdown-menu"),m=b("el-dropdown"),w=b("el-empty"),W=b("el-tab-pane"),ee=b("el-badge"),X=b("el-form-item"),Z=b("el-form"),u=b("el-tabs"),t=b("el-dialog");return g(),F("div",Dt,[e(u,{modelValue:a.value,"onUpdate:modelValue":d[2]||(d[2]=r=>a.value=r),class:"friend-tabs"},{default:s(()=>[e(W,{label:"好友列表",name:"list"},{default:s(()=>[n("div",It,[n("div",Et,[e(q,{modelValue:c.value,"onUpdate:modelValue":d[0]||(d[0]=r=>c.value=r),placeholder:"搜索好友","prefix-icon":U(Be),clearable:"",onInput:p},null,8,["modelValue","prefix-icon"])]),n("div",Lt,[(g(!0),F(de,null,me(i.value,r=>{var D,E,H,ce;return g(),F("div",{key:r.id,class:"friend-item"},[n("div",{class:"friend-main",onClick:ve=>z(r)},[e(J,{size:48,src:(D=r.friend_user)==null?void 0:D.avatar},{default:s(()=>{var ve,ke;return[G(N(((ke=(ve=r.friend_user)==null?void 0:ve.nickname)==null?void 0:ke[0])||"?"),1)]}),_:2},1032,["src"]),n("div",qt,[n("div",Ot,N(r.remark||((E=r.friend_user)==null?void 0:E.nickname)),1),n("div",Wt,[r.remark!==((H=r.friend_user)==null?void 0:H.nickname)?(g(),F("span",Ht," 昵称: "+N((ce=r.friend_user)==null?void 0:ce.nickname),1)):P("",!0),n("span",Pt,N(r.group_name||"默认分组"),1)])])],8,Rt),e(m,{trigger:"click",onCommand:ve=>j(ve,r)},{dropdown:s(()=>[e($e,null,{default:s(()=>[e(pe,{command:"chat"},{default:s(()=>[...d[10]||(d[10]=[G("发消息",-1)])]),_:1}),e(pe,{command:"remark"},{default:s(()=>[...d[11]||(d[11]=[G("设置备注",-1)])]),_:1}),e(pe,{command:"delete",divided:""},{default:s(()=>[...d[12]||(d[12]=[G("删除好友",-1)])]),_:1})]),_:1})]),default:s(()=>[e(Y,{text:"",circle:""},{default:s(()=>[e(le,null,{default:s(()=>[e(I)]),_:1})]),_:1})]),_:1},8,["onCommand"])])}),128)),i.value.length===0?(g(),K(w,{key:0,description:"暂无好友"})):P("",!0)])])]),_:1}),e(W,{name:"requests"},{label:s(()=>[d[13]||(d[13]=n("span",null,"好友请求",-1)),A.value.length>0?(g(),K(ee,{key:0,value:A.value.length,class:"request-badge"},null,8,["value"])):P("",!0)]),default:s(()=>[n("div",Kt,[n("div",jt,[(g(!0),F(de,null,me(A.value,r=>{var D,E;return g(),F("div",{key:r.id,class:"request-item"},[e(J,{size:48,src:(D=r.from_user)==null?void 0:D.avatar},{default:s(()=>{var H,ce;return[G(N(((ce=(H=r.from_user)==null?void 0:H.nickname)==null?void 0:ce[0])||"?"),1)]}),_:2},1032,["src"]),n("div",Jt,[n("div",Yt,N((E=r.from_user)==null?void 0:E.nickname),1),r.message?(g(),F("div",Zt,N(r.message),1)):P("",!0),n("div",Qt,N($(r.created_at)),1)]),n("div",Xt,[e(Y,{type:"primary",size:"small",onClick:H=>ne(r.id,"accept")},{default:s(()=>[...d[14]||(d[14]=[G(" 接受 ",-1)])]),_:1},8,["onClick"]),e(Y,{size:"small",onClick:H=>ne(r.id,"reject")},{default:s(()=>[...d[15]||(d[15]=[G(" 拒绝 ",-1)])]),_:1},8,["onClick"])])])}),128)),A.value.length===0?(g(),K(w,{key:0,description:"暂无好友请求"})):P("",!0)])])]),_:1}),e(W,{label:"添加好友",name:"add"},{default:s(()=>[n("div",es,[e(Z,{model:T.value,"label-position":"top"},{default:s(()=>[e(X,{label:"搜索用户"},{default:s(()=>[e(q,{modelValue:T.value.keyword,"onUpdate:modelValue":d[1]||(d[1]=r=>T.value.keyword=r),placeholder:"输入用户名或昵称",onKeyup:Je(ie,["enter"])},{append:s(()=>[e(Y,{icon:U(Be),onClick:ie},null,8,["icon"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"]),_.value.length>0?(g(),F("div",ts,[d[17]||(d[17]=n("div",{class:"results-title"},"搜索结果",-1)),(g(!0),F(de,null,me(_.value,r=>(g(),F("div",{key:r.id,class:"user-item"},[e(J,{size:40,src:r.avatar},{default:s(()=>{var D;return[G(N(((D=r.nickname)==null?void 0:D[0])||"?"),1)]}),_:2},1032,["src"]),n("div",ss,[n("div",ns,N(r.nickname),1),n("div",as,"@"+N(r.username),1)]),e(Y,{type:"primary",size:"small",onClick:D=>M(r)},{default:s(()=>[...d[16]||(d[16]=[G(" 添加 ",-1)])]),_:1},8,["onClick"])]))),128))])):x.value&&_.value.length===0?(g(),K(w,{key:1,description:"未找到用户"})):(g(),K(w,{key:2,description:"搜索用户来添加好友"}))])]),_:1})]),_:1},8,["modelValue"]),e(t,{modelValue:v.value,"onUpdate:modelValue":d[6]||(d[6]=r=>v.value=r),title:"设置备注",width:"400px"},{footer:s(()=>[e(Y,{onClick:d[5]||(d[5]=r=>v.value=!1)},{default:s(()=>[...d[18]||(d[18]=[G("取消",-1)])]),_:1}),e(Y,{type:"primary",onClick:se},{default:s(()=>[...d[19]||(d[19]=[G("保存",-1)])]),_:1})]),default:s(()=>[e(Z,{model:k.value,"label-width":"80px"},{default:s(()=>[e(X,{label:"备注名"},{default:s(()=>[e(q,{modelValue:k.value.remark,"onUpdate:modelValue":d[3]||(d[3]=r=>k.value.remark=r),placeholder:"请输入备注名",maxlength:"50"},null,8,["modelValue"])]),_:1}),e(X,{label:"分组"},{default:s(()=>[e(q,{modelValue:k.value.groupName,"onUpdate:modelValue":d[4]||(d[4]=r=>k.value.groupName=r),placeholder:"请输入分组名"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),e(t,{modelValue:h.value,"onUpdate:modelValue":d[9]||(d[9]=r=>h.value=r),title:"添加好友",width:"400px"},{footer:s(()=>[e(Y,{onClick:d[8]||(d[8]=r=>h.value=!1)},{default:s(()=>[...d[20]||(d[20]=[G("取消",-1)])]),_:1}),e(Y,{type:"primary",onClick:R},{default:s(()=>[...d[21]||(d[21]=[G("发送请求",-1)])]),_:1})]),default:s(()=>[e(Z,{model:l.value,"label-width":"80px"},{default:s(()=>[e(X,{label:"对方"},{default:s(()=>{var r,D;return[n("div",os,[e(J,{size:32,src:(r=o.value)==null?void 0:r.avatar},{default:s(()=>{var E,H;return[G(N((H=(E=o.value)==null?void 0:E.nickname)==null?void 0:H[0]),1)]}),_:1},8,["src"]),n("span",null,N((D=o.value)==null?void 0:D.nickname),1)])]}),_:1}),e(X,{label:"验证消息"},{default:s(()=>[e(q,{modelValue:l.value.message,"onUpdate:modelValue":d[7]||(d[7]=r=>l.value.message=r),type:"textarea",rows:3,placeholder:"请输入验证消息（可选）",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),ls=we(rs,[["__scopeId","data-v-593f786f"]]),is={class:"group-list-container"},us={class:"list-header"},cs={class:"group-list"},ds=["onClick"],ms={class:"item-content"},_s={class:"item-name"},vs={class:"item-meta"},ps=he({__name:"GroupList",emits:["select"],setup(y,{emit:V}){const a=V,c=Ae(),T=C(!1),_=C({name:"",max_members:100}),x=Q(()=>{var h;return(h=c.currentGroup)==null?void 0:h.id}),A={},v=h=>{if(!A[h]){const l=["#F56C6C","#E6A23C","#67C23A","#409EFF","#909399"];A[h]=l[h%l.length]}return A[h]},k=h=>{a("select",h)},S=async()=>{if(_.value.name.trim())try{const h=await c.createGroup({name:_.value.name,max_members:_.value.max_members});h&&(L.success("群组创建成功"),T.value=!1,_.value.name="",_.value.max_members=100,k(h))}catch(h){L.error(h.message||"创建失败")}};return Te(()=>{c.groups.length||c.loadGroups()}),(h,l)=>{const o=b("el-icon"),i=b("el-button"),f=b("el-skeleton"),$=b("el-avatar"),p=b("el-empty"),z=b("el-input"),j=b("el-form-item"),se=b("el-input-number"),ae=b("el-form"),ie=b("el-dialog");return g(),F("div",is,[n("div",us,[l[5]||(l[5]=n("div",{class:"list-title"},"我的群组",-1)),e(i,{type:"primary",size:"small",circle:"",onClick:l[0]||(l[0]=M=>T.value=!0)},{default:s(()=>[e(o,null,{default:s(()=>[e(U(Ze))]),_:1})]),_:1})]),n("div",cs,[U(c).loading?(g(),K(f,{key:0,rows:3,animated:"",class:"p-4"})):U(c).groups&&U(c).groups.length>0?(g(!0),F(de,{key:1},me(U(c).groups.filter(M=>M!=null),M=>(g(),F("div",{key:M.id,class:_e(["list-item",{active:x.value===M.id}]),onClick:R=>k(M)},[e($,{size:48,style:Me({backgroundColor:v(M.id)}),shape:"square",class:"item-avatar"},{default:s(()=>[e(o,{size:"24",color:"white"},{default:s(()=>[e(U(Ne))]),_:1})]),_:1},8,["style"]),n("div",ms,[n("div",_s,N(M.name),1),n("div",vs,N(M.member_count)+" 成员",1)])],10,ds))),128)):(g(),K(p,{key:2,description:"暂无群组","image-size":60}))]),e(ie,{modelValue:T.value,"onUpdate:modelValue":l[4]||(l[4]=M=>T.value=M),title:"创建群组",width:"400px","append-to-body":""},{footer:s(()=>[e(i,{onClick:l[3]||(l[3]=M=>T.value=!1)},{default:s(()=>[...l[6]||(l[6]=[G("取消",-1)])]),_:1}),e(i,{type:"primary",onClick:S,disabled:!_.value.name.trim()},{default:s(()=>[...l[7]||(l[7]=[G(" 创建 ",-1)])]),_:1},8,["disabled"])]),default:s(()=>[e(ae,{model:_.value,"label-width":"80px"},{default:s(()=>[e(j,{label:"群名称"},{default:s(()=>[e(z,{modelValue:_.value.name,"onUpdate:modelValue":l[1]||(l[1]=M=>_.value.name=M),placeholder:"请输入群名称",maxlength:"50"},null,8,["modelValue"])]),_:1}),e(j,{label:"群人数"},{default:s(()=>[e(se,{modelValue:_.value.max_members,"onUpdate:modelValue":l[2]||(l[2]=M=>_.value.max_members=M),min:2,max:500},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),fs=we(ps,[["__scopeId","data-v-6c4a1f54"]]),gs={class:"bot-list-container"},ys={class:"bot-list"},hs=["onClick"],ws={class:"item-content"},ks={class:"item-name"},Ss={class:"item-desc"},bs=he({__name:"BotList",emits:["select"],setup(y,{emit:V}){const a=V,c=et(),T=Q(()=>{var k;return(k=c.currentBot)==null?void 0:k.id}),_={9001:"#409EFF",9002:"#67C23A",9003:"#E6A23C",9004:"#F56C6C"},x=k=>_[k]||"#909399",A=k=>({assistant:"智能助手",companion:"聊天伙伴",tutor:"学习导师",creative:"创意助手"})[k]||"AI 助手",v=k=>{a("select",k)};return Te(()=>{c.bots.length||c.loadBots()}),(k,S)=>{const h=b("el-icon"),l=b("el-avatar");return g(),F("div",gs,[S[0]||(S[0]=n("div",{class:"list-header"},[n("div",{class:"list-title"},"AI 助手")],-1)),n("div",ys,[(g(!0),F(de,null,me(U(c).bots,o=>(g(),F("div",{key:o.id,class:_e(["list-item",{active:T.value===o.id}]),onClick:i=>v(o)},[e(l,{size:48,style:Me({backgroundColor:x(o.id)}),shape:"square",class:"item-avatar"},{default:s(()=>[e(h,{size:"24",color:"white"},{default:s(()=>[e(U(Ne))]),_:1})]),_:1},8,["style"]),n("div",ws,[n("div",ks,N(o.name),1),n("div",Ss,N(A(o.personality)),1)])],10,hs))),128))])])}}}),Cs=we(bs,[["__scopeId","data-v-9e51ef78"]]),$s={class:"chat-window"},Ms={class:"chat-header"},Ts={class:"header-left"},xs={class:"header-info"},Vs={class:"header-title"},Bs={key:0,class:"header-subtitle"},Us={class:"header-actions"},Ns={key:0,class:"loading-state"},Fs=["id"],As={key:0,class:"message-time-divider"},Gs={class:"message-row"},zs={class:"message-content-group"},Ds={key:0,class:"message-sender-name"},Is={key:0,class:"typing-indicator"},Es={key:1,class:"message-text"},Ls={key:2,class:"empty-state"},Rs={class:"input-area"},qs={class:"input-toolbar"},Os={class:"input-footer"},Ws=he({__name:"ChatWindow",props:{messages:{},currentUserId:{},title:{},subtitle:{},avatar:{},avatarStyle:{},sending:{type:Boolean},loading:{type:Boolean},showSenderName:{type:Boolean},getSenderName:{type:Function},getSenderAvatar:{type:Function},getSenderStyle:{type:Function},highlightMessageId:{}},emits:["send"],setup(y,{expose:V,emit:a}){const c=y,T=a,_=C(""),x=C(),A=C(new Map),v=C(null),k=M=>M.from_user_id===c.currentUserId||M.role==="user",S=M=>{const R=re(M);if(!R)return"";try{return JSON.parse(R).text||R}catch{return R}},h=(M,R)=>{if(!R)return!0;const ne=new Date(M.timestamp||M.created_at).getTime(),ue=new Date(R.timestamp||R.created_at).getTime();return ne-ue>5*60*1e3},l=M=>M?new Date(typeof M=="string"&&M.length<13?parseInt(M)*1e3:M).toLocaleString("zh-CN",{hour:"2-digit",minute:"2-digit",month:"short",day:"numeric"}):"",o=()=>{!_.value.trim()||c.sending||(T("send",_.value),_.value="")},i=()=>{Ue(()=>{x.value&&(x.value.scrollTop=x.value.scrollHeight)})},f=M=>{const R=A.value.get(M);R&&x.value&&(v.value=null,Ue(()=>{v.value=M,R.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{v.value=null},3e3)}))},$=(M,R)=>{A.value.set(M,R)};ge(()=>c.highlightMessageId,M=>{M&&f(M)}),ge(()=>c.messages,()=>{i()},{deep:!0}),Te(()=>{i()}),V({scrollToMessage:f});const p=M=>M.senderName||"User",z=M=>M.senderAvatar||"",j=M=>({}),se=c.getSenderName||p,ae=c.getSenderAvatar||z,ie=c.getSenderStyle||j;return(M,R)=>{const ne=b("el-icon"),ue=b("el-avatar"),B=b("el-skeleton"),d=b("el-empty"),q=b("el-button"),J=b("el-input");return g(),F("div",$s,[n("div",Ms,[n("div",Ts,[Ke(M.$slots,"header-prefix",{},void 0,!0),e(ue,{size:40,src:y.avatar,style:Me(y.avatarStyle)},{default:s(()=>{var I;return[G(N(((I=y.title)==null?void 0:I[0])||"?")+" ",1),!y.title&&!y.avatar?(g(),K(ne,{key:0},{default:s(()=>[e(U(it))]),_:1})):P("",!0)]}),_:1},8,["src","style"]),n("div",xs,[n("div",Vs,N(y.title),1),y.subtitle?(g(),F("div",Bs,N(y.subtitle),1)):P("",!0)])]),n("div",Us,[Ke(M.$slots,"actions",{},void 0,!0)])]),n("div",{class:"messages-container",ref_key:"messagesRef",ref:x},[y.loading?(g(),F("div",Ns,[e(B,{rows:3,animated:""})])):(g(!0),F(de,{key:1},me(y.messages,(I,le)=>(g(),F("div",{key:I.id||le,id:"msg-"+(I.msg_id||I.id),ref_for:!0,ref:Y=>Y&&$(I.msg_id||I.id,Y),class:_e(["message-wrapper",{"is-me":k(I),highlighted:v.value===(I.msg_id||I.id)}])},[h(I,y.messages[le-1])?(g(),F("div",As,[n("span",null,N(l(I.timestamp||I.created_at)),1)])):P("",!0),n("div",Gs,[e(ue,{class:"message-avatar",size:36,src:U(ae)(I),style:Me(U(ie)(I))},{default:s(()=>{var Y;return[G(N(((Y=U(se)(I))==null?void 0:Y[0])||"?"),1)]}),_:2},1032,["src","style"]),n("div",zs,[!k(I)&&y.showSenderName?(g(),F("div",Ds,N(U(se)(I)),1)):P("",!0),n("div",{class:_e(["message-bubble",{typing:I.isTyping}])},[I.isTyping?(g(),F("div",Is,[...R[1]||(R[1]=[n("span",null,null,-1),n("span",null,null,-1),n("span",null,null,-1)])])):(g(),F("div",Es,N(S(I.content)),1))],2)])])],10,Fs))),128)),y.messages.length===0&&!y.loading?(g(),F("div",Ls,[e(d,{description:"暂无消息"})])):P("",!0)],512),n("div",Rs,[n("div",qs,[e(q,{text:"",circle:"",size:"small"},{default:s(()=>[e(ne,null,{default:s(()=>[e(U(ut))]),_:1})]),_:1}),e(q,{text:"",circle:"",size:"small"},{default:s(()=>[e(ne,null,{default:s(()=>[e(U(ct))]),_:1})]),_:1})]),e(J,{modelValue:_.value,"onUpdate:modelValue":R[0]||(R[0]=I=>_.value=I),type:"textarea",rows:3,placeholder:"输入消息...",resize:"none",onKeydown:Je(Qe(o,["exact","prevent"]),["enter"]),class:"chat-input"},null,8,["modelValue","onKeydown"]),n("div",Os,[R[3]||(R[3]=n("span",{class:"input-hint"},"Enter 发送，Shift + Enter 换行",-1)),e(q,{type:"primary",onClick:o,disabled:!_.value.trim()||y.sending,loading:y.sending},{default:s(()=>[...R[2]||(R[2]=[G(" 发送 ",-1)])]),_:1},8,["disabled","loading"])])])])}}}),Hs=we(Ws,[["__scopeId","data-v-96d06fcb"]]),Ps={class:"group-sidebar"},Ks={class:"sidebar-close"},js={class:"group-info-section"},Js={class:"group-header"},Ys={class:"group-meta"},Zs={class:"group-name"},Qs={class:"group-no"},Xs={class:"group-stats"},en={class:"stat-item"},tn={class:"stat-value"},sn={class:"stat-item"},nn={class:"stat-value"},an={class:"group-actions"},on={class:"members-section"},rn={class:"section-header"},ln={class:"members-search"},un={class:"members-list"},cn={class:"member-info"},dn={class:"member-name"},mn={class:"member-id"},_n={class:"history-section"},vn={class:"history-search"},pn={class:"history-list"},fn=["onClick"],gn={class:"msg-header"},yn={class:"msg-sender"},hn={class:"msg-time"},wn={class:"msg-content"},kn={key:0,class:"empty-history"},Sn=he({__name:"GroupSidebar",props:{group:{}},emits:["close","close-sidebar","scroll-to-message"],setup(y,{emit:V}){var Z;const a=y,c=V,T=Ve(),_=Ae();Fe();const x=C("info"),A=C(""),v=C(""),k=C(!1),S=C(!1),h=C(""),l=C(""),o=C(!1),i=C([]),f=C(!0),$=((Z=T.currentUser)==null?void 0:Z.id)||0,p=Q(()=>_.members);C({});const z=Q(()=>{var r;const u=["#F56C6C","#E6A23C","#67C23A","#409EFF","#909399"],t=((r=a.group)==null?void 0:r.id)||0;return u[t%u.length]}),j=u=>{var t;if(!u)return"未知";try{let r=re(u.nickname)||re((t=u.user)==null?void 0:t.nickname)||"";if(r&&r.startsWith("{"))try{return JSON.parse(r).String||"未知"}catch{return r}return r||"未知"}catch(r){return console.warn("Error parsing member name:",r),"未知"}},se=Q(()=>{const u=p.value.find(t=>t.role===3);return j(u)}),ae=Q(()=>{var u;return((u=a.group)==null?void 0:u.owner_id)===$}),ie=Q(()=>{const u=p.value.find(t=>t.user_id===$);return(u==null?void 0:u.role)===3||(u==null?void 0:u.role)===2}),M=Q(()=>{if(!A.value)return p.value;const u=A.value.toLowerCase();return p.value.filter(t=>j(t).toLowerCase().includes(u)||t.user_id.toString().includes(u))}),R=Q(()=>p.value.filter(u=>u.role===2||u.role===3)),ne=Q(()=>{if(!v.value)return i.value;const u=v.value.toLowerCase();return i.value.filter(t=>d(t.content).toLowerCase().includes(u))}),ue=u=>{var r;if(u.from_user_id===$)return"我";const t=p.value.find(D=>D.user_id===u.from_user_id);return(t==null?void 0:t.nickname)||((r=t==null?void 0:t.user)==null?void 0:r.nickname)||`用户${u.from_user_id}`},B=u=>{const t=new Date(u),D=new Date().getTime()-t.getTime(),E=Math.floor(D/(1e3*60*60*24));return E===0?t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):E===1?"昨天 "+t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):E<7?["周日","周一","周二","周三","周四","周五","周六"][t.getDay()]+" "+t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},d=u=>{try{return JSON.parse(u).text||u}catch{return u}},q=async()=>{var u;if(!(!a.group||v.value.length<2)){o.value=!0;try{const t=await ye.getHistory({conversation_id:a.group.id,conversation_type:2,limit:100});t.code===0&&(i.value=((u=t.data)==null?void 0:u.messages)||[])}catch(t){console.error("Failed to search messages:",t)}finally{o.value=!1}}},J=async()=>{var t;if(!a.group||i.value.length===0)return;const u=i.value[i.value.length-1].seq;o.value=!0;try{const r=await ye.getHistory({conversation_id:a.group.id,conversation_type:2,last_seq:u,limit:50});if(r.code===0){const D=((t=r.data)==null?void 0:t.messages)||[];i.value.push(...D),f.value=D.length>=50}}catch(r){console.error("Failed to load more history:",r)}finally{o.value=!1}},I=u=>{c("scroll-to-message",u)},le=async()=>{var u;if(a.group){if(!h.value){L.warning("请输入用户ID");return}try{const D=(((u=(await Ye.searchUsers(h.value)).data)==null?void 0:u.users)||[]).find(H=>H.id===Number(h.value));if(!D){L.warning("用户不存在");return}const E=await oe.invite(a.group.id,{user_id:D.id});E.code===0?(L.success("邀请成功"),k.value=!1,h.value="",await _.loadMembers(a.group.id)):L.error(E.message||"邀请失败")}catch(t){L.error(t.message||"邀请失败")}}},Y=async()=>{if(a.group)try{await fe.confirm("确定要退出群聊吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await oe.leave(a.group.id)).code===0&&(L.success("已退出群聊"),c("close"))}catch(u){u!=="cancel"&&L.error(u.message||"操作失败")}},pe=async()=>{if(a.group)try{await fe.confirm("确定要解散群聊吗？此操作不可恢复！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await oe.deleteGroup(a.group.id)).code===0&&(L.success("群聊已解散"),c("close"))}catch(u){u!=="cancel"&&L.error(u.message||"操作失败")}},$e=()=>{l.value="",S.value=!0},m=async()=>{if(a.group){if(!l.value){L.warning("请选择新群主");return}try{await fe.confirm(`确定要将群主转让给用户 ${l.value} 吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await oe.transferOwnership(a.group.id,Number(l.value))).code===0&&(L.success("群主已转让"),S.value=!1,c("close"))}catch(u){u!=="cancel"&&L.error(u.message||"操作失败")}}},w=async u=>{if(a.group)try{const{value:t}=await fe.prompt("请输入群昵称","设置昵称",{confirmButtonText:"确定",cancelButtonText:"取消",inputValue:u.nickname||"",inputPattern:/^.{1,20}$/,inputErrorMessage:"昵称长度为1-20个字符"});(await oe.setMemberNickname(a.group.id,u.user_id,t)).code===0&&(L.success("昵称已设置"),await _.loadMembers(a.group.id))}catch(t){t!=="cancel"&&L.error(t.message||"操作失败")}},W=async u=>{if(a.group)try{const t=u.role===2?1:2;(await oe.setMemberRole(a.group.id,u.user_id,t)).code===0&&(L.success("角色已更新"),await _.loadMembers(a.group.id))}catch(t){L.error(t.message||"操作失败")}},ee=async u=>{if(a.group)try{const t=u.mute_until?-1:60;(await oe.muteMember(a.group.id,u.user_id,t)).code===0&&(L.success(t>0?"已禁言60分钟":"已解除禁言"),await _.loadMembers(a.group.id))}catch(t){L.error(t.message||"操作失败")}},X=async u=>{var t;if(a.group)try{await fe.confirm(`确定要将 ${u.nickname||((t=u.user)==null?void 0:t.nickname)} 移出群聊吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await oe.kick(a.group.id,u.user_id)).code===0&&(L.success("成员已移除"),await _.loadMembers(a.group.id))}catch(r){r!=="cancel"&&L.error(r.message||"操作失败")}};return ge(()=>a.group,async u=>{var t;if(u){await _.loadMembers(u.id);const r=await ye.getHistory({conversation_id:u.id,conversation_type:2,limit:50});r.code===0&&(i.value=((t=r.data)==null?void 0:t.messages)||[])}},{immediate:!0}),(u,t)=>{const r=b("el-icon"),D=b("el-button"),E=b("el-avatar"),H=b("el-dropdown-item"),ce=b("el-dropdown-menu"),ve=b("el-dropdown"),ke=b("el-input"),Le=b("el-tab-pane"),nt=b("el-tabs"),Re=b("el-dialog"),at=b("el-option"),ot=b("el-select"),rt=_t("loading");return g(),F("div",Ps,[n("div",Ks,[e(D,{text:"",circle:"",onClick:t[0]||(t[0]=O=>c("close-sidebar"))},{default:s(()=>[e(r,null,{default:s(()=>[e(U(dt))]),_:1})]),_:1})]),e(nt,{modelValue:x.value,"onUpdate:modelValue":t[4]||(t[4]=O=>x.value=O),class:"sidebar-tabs"},{default:s(()=>[e(Le,{label:"群信息",name:"info"},{default:s(()=>{var O,Se,qe,Oe;return[n("div",js,[n("div",Js,[e(E,{size:60,src:(O=y.group)==null?void 0:O.avatar,style:Me({backgroundColor:z.value}),shape:"square"},{default:s(()=>[e(r,{size:"30",color:"white"},{default:s(()=>[e(U(Ne))]),_:1})]),_:1},8,["src","style"]),n("div",Ys,[n("h3",Zs,N((Se=y.group)==null?void 0:Se.name),1),n("p",Qs,"群号: "+N(((qe=y.group)==null?void 0:qe.id)||"未设置"),1)])]),n("div",Xs,[n("div",en,[t[11]||(t[11]=n("span",{class:"stat-label"},"群主",-1)),n("span",tn,N(se.value),1)]),n("div",sn,[t[12]||(t[12]=n("span",{class:"stat-label"},"成员",-1)),n("span",nn,N(p.value.length)+"/"+N(((Oe=y.group)==null?void 0:Oe.max_members)||500),1)])]),n("div",an,[ie.value?(g(),K(D,{key:0,type:"primary",size:"small",onClick:t[1]||(t[1]=te=>k.value=!0)},{default:s(()=>[e(r,null,{default:s(()=>[e(U(Ze))]),_:1}),t[13]||(t[13]=G(" 邀请成员 ",-1))]),_:1})):P("",!0),ae.value?P("",!0):(g(),K(D,{key:1,type:"danger",size:"small",onClick:Y},{default:s(()=>[...t[14]||(t[14]=[G(" 退出群聊 ",-1)])]),_:1})),ae.value?(g(),K(ve,{key:2,trigger:"click"},{dropdown:s(()=>[e(ce,null,{default:s(()=>[e(H,{onClick:$e},{default:s(()=>[...t[16]||(t[16]=[G("转让群主",-1)])]),_:1}),e(H,{onClick:pe,style:{color:"#f56c6c"}},{default:s(()=>[...t[17]||(t[17]=[G("解散群聊",-1)])]),_:1})]),_:1})]),default:s(()=>[e(D,{size:"small"},{default:s(()=>[t[15]||(t[15]=G(" 更多 ",-1)),e(r,null,{default:s(()=>[e(U(mt))]),_:1})]),_:1})]),_:1})):P("",!0)])]),n("div",on,[n("div",rn,[n("span",null,"群成员 ("+N(p.value.length)+")",1)]),n("div",ln,[e(ke,{modelValue:A.value,"onUpdate:modelValue":t[2]||(t[2]=te=>A.value=te),placeholder:"搜索成员","prefix-icon":U(Be),size:"small",clearable:""},null,8,["modelValue","prefix-icon"])]),n("div",un,[(g(!0),F(de,null,me(M.value,te=>{var We;return g(),F("div",{key:te.user_id,class:"member-item"},[e(E,{size:36,src:(We=te.user)==null?void 0:We.avatar},{default:s(()=>{var be,He;return[G(N(((He=(be=te.user)==null?void 0:be.nickname)==null?void 0:He[0])||"?"),1)]}),_:2},1032,["src"]),n("div",cn,[n("div",dn,[G(N(j(te))+" ",1),te.role===3?(g(),K(U(je),{key:0,size:"small",type:"danger"},{default:s(()=>[...t[18]||(t[18]=[G("群主",-1)])]),_:1})):P("",!0),te.role===2?(g(),K(U(je),{key:1,size:"small",type:"warning"},{default:s(()=>[...t[19]||(t[19]=[G("管理员",-1)])]),_:1})):P("",!0)]),n("div",mn,"ID: "+N(te.user_id),1)]),ie.value&&te.user_id!==U($)?(g(),K(ve,{key:0,trigger:"click"},{dropdown:s(()=>[e(ce,null,{default:s(()=>[e(H,{onClick:be=>w(te)},{default:s(()=>[...t[20]||(t[20]=[G("设置昵称",-1)])]),_:1},8,["onClick"]),ae.value?(g(),K(H,{key:0,onClick:be=>W(te)},{default:s(()=>[G(" 设为"+N(te.role===2?"普通成员":"管理员"),1)]),_:2},1032,["onClick"])):P("",!0),e(H,{onClick:be=>ee(te)},{default:s(()=>[G(N(te.mute_until?"解除禁言":"禁言"),1)]),_:2},1032,["onClick"]),e(H,{onClick:be=>X(te),style:{color:"#f56c6c"}},{default:s(()=>[...t[21]||(t[21]=[G(" 移除成员 ",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),default:s(()=>[e(D,{text:"",circle:"",size:"small"},{default:s(()=>[e(r,null,{default:s(()=>[e(U(Xe))]),_:1})]),_:1})]),_:2},1024)):P("",!0)])}),128))])])]}),_:1}),e(Le,{label:"历史消息",name:"history"},{default:s(()=>[n("div",_n,[n("div",vn,[e(ke,{modelValue:v.value,"onUpdate:modelValue":t[3]||(t[3]=O=>v.value=O),placeholder:"搜索消息内容","prefix-icon":U(Be),size:"small",clearable:"",onInput:q},null,8,["modelValue","prefix-icon"])]),xe((g(),F("div",pn,[(g(!0),F(de,null,me(ne.value,O=>(g(),F("div",{key:O.id,class:"history-message",onClick:Se=>I(O)},[n("div",gn,[n("span",yn,N(ue(O)),1),n("span",hn,N(B(O.created_at)),1)]),n("div",wn,N(d(O.content)),1)],8,fn))),128)),ne.value.length===0&&!o.value?(g(),F("div",kn," 暂无历史消息 ")):P("",!0),f.value?(g(),F("div",{key:1,class:"load-more",onClick:J}," 加载更多 ")):P("",!0)])),[[rt,o.value]])])]),_:1})]),_:1},8,["modelValue"]),e(Re,{modelValue:k.value,"onUpdate:modelValue":t[7]||(t[7]=O=>k.value=O),title:"邀请成员",width:"400px"},{footer:s(()=>[e(D,{onClick:t[6]||(t[6]=O=>k.value=!1)},{default:s(()=>[...t[22]||(t[22]=[G("取消",-1)])]),_:1}),e(D,{type:"primary",onClick:le},{default:s(()=>[...t[23]||(t[23]=[G("邀请",-1)])]),_:1})]),default:s(()=>[e(ke,{modelValue:h.value,"onUpdate:modelValue":t[5]||(t[5]=O=>h.value=O),placeholder:"输入用户ID或用户名",clearable:""},null,8,["modelValue"])]),_:1},8,["modelValue"]),e(Re,{modelValue:S.value,"onUpdate:modelValue":t[10]||(t[10]=O=>S.value=O),title:"转让群主",width:"400px"},{footer:s(()=>[e(D,{onClick:t[9]||(t[9]=O=>S.value=!1)},{default:s(()=>[...t[24]||(t[24]=[G("取消",-1)])]),_:1}),e(D,{type:"primary",onClick:m},{default:s(()=>[...t[25]||(t[25]=[G("确认转让",-1)])]),_:1})]),default:s(()=>[e(ot,{modelValue:l.value,"onUpdate:modelValue":t[8]||(t[8]=O=>l.value=O),placeholder:"选择新群主",style:{width:"100%"}},{default:s(()=>[(g(!0),F(de,null,me(R.value,O=>{var Se;return g(),K(at,{key:O.user_id,label:O.nickname||((Se=O.user)==null?void 0:Se.nickname),value:O.user_id},null,8,["label","value"])}),128))]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])])}}}),bn=we(Sn,[["__scopeId","data-v-499db170"]]),Cn={class:"main-layout"},$n={class:"icon-sidebar"},Mn={class:"app-logo"},Tn={class:"nav-items"},xn={class:"bottom-actions"},Vn={class:"user-dropdown-header"},Bn={class:"dropdown-name"},Un={class:"list-sidebar"},Nn={class:"sidebar-search"},Fn={class:"sidebar-content"},An={class:"main-content"},Gn={key:0,class:"chat-container"},zn={class:"header-actions-wrapper"},Dn={key:0,class:"sidebar-wrapper"},In={key:1,class:"empty-state"},En=he({__name:"Main",setup(y){const V=wt(),a=Ve(),c=Fe(),T=Ae(),_=et(),x=C("chats"),A=C(""),v=C(null),k=C(!1),S=C(),{messages:h,connect:l,disconnect:o}=Mt("ws://localhost:3102/sub"),i=Q(()=>{var m;return v.value==="ai"?_.currentBot?_.getBotMessages(_.currentBot.id):[]:((m=c.currentSession)==null?void 0:m.messages)||[]}),f=Q(()=>{var m,w;return v.value==="ai"?((m=_.currentBot)==null?void 0:m.name)||"AI":((w=c.currentSession)==null?void 0:w.name)||"Chat"}),$=Q(()=>{var m;return v.value==="ai"?((m=_.currentBot)==null?void 0:m.personality)||"Assistant":v.value==="group"?`${T.members.length} members`:"Online"}),p=Q(()=>{var m;return v.value==="ai"?"":(m=c.currentSession)==null?void 0:m.avatar}),z=Q(()=>{var m;if(v.value==="ai"&&_.currentBot)return{backgroundColor:{9001:"#409EFF",9002:"#67C23A",9003:"#E6A23C",9004:"#F56C6C"}[_.currentBot.id]||"#909399"};if(v.value==="group"){const w=["#F56C6C","#E6A23C","#67C23A","#409EFF","#909399"],W=((m=c.currentSession)==null?void 0:m.targetId)||0;return{backgroundColor:w[W%w.length]}}return{}}),j=Q(()=>v.value==="ai"?_.sending:!1),se=Q(()=>!1),ae=async m=>{var ee,X;console.log("handleConversationSelect:",m.conversation_type,"current activeSessionType:",v.value),k.value=!1,console.log("set showGroupSidebar to false"),await Ue(),v.value=m.conversation_type===2?"group":"private";const w=re((ee=m.target_user)==null?void 0:ee.nickname),W=re((X=m.target_user)==null?void 0:X.avatar);await c.openChat(m.target_id,m.conversation_type,w,W),v.value==="group"&&await le(m.target_id),console.log("after handleConversationSelect, activeSessionType:",v.value,"showGroupSidebar:",k.value)},ie=m=>{var W,ee;console.log("handleFriendChat"),k.value=!1,console.log("set showGroupSidebar to false");const w=((W=m.friend_user)==null?void 0:W.id)||m.friend_id;v.value="private",c.openChat(w,1,m.remark||((ee=m.friend_user)==null?void 0:ee.nickname)),x.value="chats",console.log("after handleFriendChat, activeSessionType:",v.value,"showGroupSidebar:",k.value)},M=async m=>{console.log("handleGroupSelect"),k.value=!1,console.log("set showGroupSidebar to false"),await Ue(),v.value="group",await T.setCurrentGroup(m),c.openChat(m.id,2,m.name),await le(m.id),console.log("after handleGroupSelect, activeSessionType:",v.value,"showGroupSidebar:",k.value)},R=m=>{console.log("handleBotSelect"),v.value="ai",k.value=!1,_.setCurrentBot(m),console.log("after handleBotSelect, activeSessionType:",v.value,"showGroupSidebar:",k.value)},ne=()=>{k.value=!k.value},ue=async m=>{if(v.value==="ai")_.currentBot&&await _.sendMessage(_.currentBot.id,m);else{const w=v.value==="group"?2:1;await c.sendMessage(JSON.stringify({text:m}),w)}},B=async()=>{try{await fe.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),o(),a.logout(),V.push("/login")}catch{}},d=async()=>{k.value=!1,T.clearCurrentGroup(),v.value=null,await c.loadConversations()},q=m=>{const w=m.msg_id||m.id;S.value&&w&&S.value.scrollToMessage(w)},J=async()=>{_.currentBot&&_.clearMessages(_.currentBot.id)},I=C(new Map),le=async m=>{I.value.has(m)||await T.loadGroups()},Y=m=>{var w,W,ee,X;if(m.role)return m.role==="user"?"我":((w=_.currentBot)==null?void 0:w.name)||"AI";if(m.from_user_id===((W=a.currentUser)==null?void 0:W.id))return"我";if(v.value==="group"){const Z=T.members.find(u=>u.user_id===m.from_user_id);return((ee=Z==null?void 0:Z.user)==null?void 0:ee.nickname)||(Z==null?void 0:Z.nickname)||`User ${m.from_user_id}`}return((X=c.currentSession)==null?void 0:X.name)||"User"},pe=m=>{var w,W,ee,X;if(m.role==="assistant")return"";if(m.from_user_id===((w=a.currentUser)==null?void 0:w.id))return((W=a.currentUser)==null?void 0:W.avatar)||"";if(v.value==="group"){const Z=T.members.find(u=>u.user_id===m.from_user_id);return((ee=Z==null?void 0:Z.user)==null?void 0:ee.avatar)||""}return((X=c.currentSession)==null?void 0:X.avatar)||""},$e=m=>m.role==="assistant"&&_.currentBot?z.value:{};return Te(async()=>{if(a.isLoggedIn){await Promise.all([c.loadConversations(),c.loadFriends()]);try{l(a.token,a.currentUser.id)}catch(m){console.warn("WS failed",m)}}}),ge(v,(m,w)=>{console.log("activeSessionType changed from",w,"to",m),m!=="group"&&(k.value=!1,console.log("auto-close sidebar because newType is not group"))}),ge(h,m=>{if(m.length>0){const w=m[m.length-1];(w.conversation_type===1||w.conversation_type===2)&&c.addMessage({id:Date.now(),msg_id:w.msg_id,from_user_id:w.from_user_id,conversation_id:w.conversation_id,conversation_type:w.conversation_type,msg_type:w.msg_type,content:w.content,seq:w.seq,created_at:new Date(w.created_at).toISOString()})}}),ge(x,()=>{k.value=!1}),ge(()=>{var m;return(m=c.currentSession)==null?void 0:m.id},()=>{k.value=!1}),(m,w)=>{var D;const W=b("el-icon"),ee=b("el-avatar"),X=b("el-dropdown-item"),Z=b("el-dropdown-menu"),u=b("el-dropdown"),t=b("el-input"),r=b("el-button");return g(),F("div",Cn,[n("div",$n,[n("div",Mn,[e(W,{size:32,color:"#6366f1"},{default:s(()=>[e(U(Ne))]),_:1})]),n("div",Tn,[n("div",{class:_e(["nav-item",{active:x.value==="chats"}]),onClick:w[0]||(w[0]=E=>x.value="chats"),title:"聊天"},[e(W,{size:24},{default:s(()=>[e(U(vt))]),_:1})],2),n("div",{class:_e(["nav-item",{active:x.value==="friends"}]),onClick:w[1]||(w[1]=E=>x.value="friends"),title:"好友"},[e(W,{size:24},{default:s(()=>[e(U(pt))]),_:1})],2),n("div",{class:_e(["nav-item",{active:x.value==="groups"}]),onClick:w[2]||(w[2]=E=>x.value="groups"),title:"群组"},[e(W,{size:24},{default:s(()=>[e(U(ft))]),_:1})],2),n("div",{class:_e(["nav-item",{active:x.value==="ai"}]),onClick:w[3]||(w[3]=E=>x.value="ai"),title:"AI 助手"},[e(W,{size:24},{default:s(()=>[e(U(gt))]),_:1})],2)]),n("div",xn,[e(u,{trigger:"click",placement:"right-end"},{dropdown:s(()=>[e(Z,null,{default:s(()=>{var E;return[n("div",Vn,[n("div",Bn,N((E=U(a).currentUser)==null?void 0:E.nickname),1),w[6]||(w[6]=n("div",{class:"dropdown-status"},"在线",-1))]),e(X,{divided:"",onClick:B},{default:s(()=>[e(W,null,{default:s(()=>[e(U(yt))]),_:1}),w[7]||(w[7]=G("退出登录 ",-1))]),_:1})]}),_:1})]),default:s(()=>{var E;return[e(ee,{size:40,src:(E=U(a).currentUser)==null?void 0:E.avatar,class:"user-avatar"},{default:s(()=>{var H,ce;return[G(N((ce=(H=U(a).currentUser)==null?void 0:H.nickname)==null?void 0:ce[0]),1)]}),_:1},8,["src"])]}),_:1})])]),n("div",Un,[n("div",Nn,[e(t,{modelValue:A.value,"onUpdate:modelValue":w[4]||(w[4]=E=>A.value=E),placeholder:"搜索...","prefix-icon":"Search",class:"custom-input"},null,8,["modelValue"])]),n("div",Fn,[x.value==="chats"?(g(),K(zt,{key:0,onSelect:ae})):x.value==="friends"?(g(),K(ls,{key:1,onChat:ie})):x.value==="groups"?(g(),K(fs,{key:2,onSelect:M})):x.value==="ai"?(g(),K(Cs,{key:3,onSelect:R})):P("",!0)])]),n("div",An,[v.value?(g(),F("div",Gn,[e(Hs,{ref_key:"chatWindowRef",ref:S,messages:i.value,"current-user-id":((D=U(a).currentUser)==null?void 0:D.id)||0,title:f.value,subtitle:$.value,avatar:p.value,"avatar-style":z.value,sending:j.value,loading:se.value,"show-sender-name":v.value==="group","get-sender-name":Y,"get-sender-avatar":pe,"get-sender-style":$e,onSend:ue},{actions:s(()=>[n("div",zn,[xe(e(r,{key:"group-btn",text:"",circle:"",onClick:Qe(ne,["stop"])},{default:s(()=>[e(W,null,{default:s(()=>[e(U(Xe))]),_:1})]),_:1},512),[[Ge,v.value==="group"]]),xe(e(r,{key:"ai-btn",text:"",circle:"",onClick:J},{default:s(()=>[e(W,null,{default:s(()=>[e(U(ht))]),_:1})]),_:1},512),[[Ge,v.value==="ai"]])])]),_:1},8,["messages","current-user-id","title","subtitle","avatar","avatar-style","sending","loading","show-sender-name"]),v.value==="group"&&U(T).currentGroup?(g(),F("div",Dn,[xe((g(),K(bn,{key:U(T).currentGroup.id,group:U(T).currentGroup,onCloseSidebar:w[5]||(w[5]=E=>k.value=!1),onClose:d,onScrollToMessage:q},null,8,["group"])),[[Ge,k.value]])])):P("",!0)])):(g(),F("div",In,[...w[8]||(w[8]=[n("div",{class:"empty-content"},[n("img",{src:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?prompt=minimalist%20chat%20illustration%20vector%20flat%20design%20blue&image_size=square_hd",alt:"Empty State",class:"empty-img"}),n("h3",null,"开始聊天"),n("p",null,"选择一个联系人或群组开始对话")],-1)])]))])])}}}),Rn=we(En,[["__scopeId","data-v-a1cbe33d"]]);export{Rn as default};
