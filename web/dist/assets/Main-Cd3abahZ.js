import{p as Ie,r as M,q as lt,s as be,v as ge,u as Ve,x as ne,y as Ke,d as ye,z as Z,c as N,o as f,A as K,B as P,F as le,g as ie,C as de,e,b as n,w as s,m as A,t as B,f as b,j as U,_ as he,D as xe,G as Be,i as Je,E as L,H as fe,I as Ye,J as Ze,K as Ne,L as Me,M as Ce,N as je,O as Qe,P as Ue,Q as it,R as ut,S as ct,T as dt,U as mt,V as Xe,W as Te,X as _t,Y as Ae,Z as vt,k as pt,$ as ft,a0 as gt,a1 as yt,a2 as ht,h as wt}from"./index-Dox2VBgN.js";const Ee=Ie("chat",()=>{const g=M([]),x=M([]),a=M(null),d=M(new Map),$=async()=>{var h;const S=await lt.getList();S.code===0&&(g.value=((h=S.data)==null?void 0:h.conversations)||[])};return{conversations:g,friends:x,currentSession:a,sessions:d,loadConversations:$,loadFriends:async()=>{var h;const S=await be.getFriends();S.code===0&&(x.value=((h=S.data)==null?void 0:h.friends)||[])},openChat:async(S,h,i,r)=>{var C;const u=`${S}:${h}`;if(!d.value.has(u)){const v=await ge.getHistory({conversation_id:S,conversation_type:h,limit:50}),G={id:u,targetId:S,targetType:h===1?"user":"group",name:i||`Chat ${S}`,avatar:r,unreadCount:0,messages:((C=v==null?void 0:v.data)==null?void 0:C.messages)||[]};d.value.set(u,G)}a.value=d.value.get(u);const y=g.value.find(v=>v.target_id===S&&v.conversation_type===h);if(y&&y.unread_count>0){const v=d.value.get(u);if(v&&v.messages.length>0){const G=v.messages[v.messages.length-1];await ge.markRead({conversation_id:S,conversation_type:h,msg_id:G.id}),y.unread_count=0}}},sendMessage:async(S,h=1)=>{var y,C,v,G,j,z;if(!a.value)return!1;const r=((y=Ve().currentUser)==null?void 0:y.id)||0,u=await ge.send({to_user_id:a.value.targetType==="user"?a.value.targetId:void 0,to_group_id:a.value.targetType==="group"?a.value.targetId:void 0,conversation_type:a.value.targetType==="user"?1:2,msg_type:h,content:S});if(u.code===0){const I={id:Date.now(),msg_id:(C=u.data)==null?void 0:C.msg_id,from_user_id:r,conversation_id:(v=u.data)==null?void 0:v.conversation_id,conversation_type:(G=u.data)==null?void 0:G.conversation_type,msg_type:h,content:S,seq:(j=u.data)==null?void 0:j.seq,created_at:(z=u.data)==null?void 0:z.created_at};return a.value.messages.push(I),!0}return!1},addMessage:S=>{const h=`${S.conversation_id}:${S.conversation_type}`;let i=d.value.get(h);i||(i={id:h,targetId:S.conversation_id,targetType:S.conversation_type===1?"user":"group",name:`Chat ${S.conversation_id}`,unreadCount:0,messages:[]},d.value.set(h,i)),i.messages.push(S),$()},getSessionKey:S=>{var y;const i=((y=Ve().currentUser)==null?void 0:y.id)||0,r=Math.min(i,S),u=Math.max(i,S);return`${r*1e9+u}:1`}}}),Fe=Ie("group",()=>{const g=M([]),x=M(null),a=M([]),d=M(!1),$=async()=>{var r;d.value=!0;try{const u=await ne.getList();if(u.code===0){const y=((r=u.data)==null?void 0:r.groups)||[];g.value=y.filter(C=>C!=null&&C.id!=null)}else g.value=[]}catch(u){throw console.error("Failed to load groups:",u),g.value=[],u}finally{d.value=!1}},_=async r=>{d.value=!0;try{const u=await ne.create(r);if(u.code===0){const y={id:u.data.group_id,group_no:u.data.group_no,name:u.data.name,owner_id:u.data.owner_id,max_members:u.data.max_members,join_type:1,mute_all:0,member_count:1,created_at:new Date().toISOString()};return g.value.push(y),y}return null}catch(u){throw console.error("Failed to create group:",u),u}finally{d.value=!1}},T=async r=>{x.value=r,await F(r.id)},F=async r=>{var u;try{const y=await ne.getMembers(r);if(y.code===0){const C=((u=y.data)==null?void 0:u.members)||[];a.value=C.filter(v=>v!=null&&v.id!=null)}else a.value=[]}catch(y){throw console.error("Failed to load members:",y),a.value=[],y}};return{groups:g,currentGroup:x,members:a,loading:d,loadGroups:$,createGroup:_,setCurrentGroup:T,loadMembers:F,joinGroup:async(r,u)=>{try{return(await ne.join(r,u)).code===0?(await $(),!0):!1}catch(y){throw console.error("Failed to join group:",y),y}},leaveGroup:async r=>{var u;try{return(await ne.leave(r)).code===0?(g.value=g.value.filter(C=>C.id!==r),((u=x.value)==null?void 0:u.id)===r&&(x.value=null,a.value=[]),!0):!1}catch(y){throw console.error("Failed to leave group:",y),y}},sendMessage:async(r,u)=>{try{return(await ge.send({to_group_id:r,conversation_type:2,msg_type:1,content:JSON.stringify({text:u})})).code===0}catch(y){throw console.error("Failed to send message:",y),y}},getGroupById:r=>g.value.find(u=>u.id===r),clearCurrentGroup:()=>{x.value=null,a.value=[]}}}),et=Ie("ai",()=>{const g=M([]),x=M(null),a=M(new Map),d=M(!1),$=M(!1),_=async()=>{try{const r=await Ke.getBots();r.code===0&&(g.value=r.data.bots||[])}catch(r){throw console.error("Failed to load AI bots:",r),r}},T=r=>a.value.get(r)||[],F=r=>{x.value=r,a.value.has(r.id)||a.value.set(r.id,[])},p=async(r,u)=>{if(!u.trim())return null;$.value=!0;const y={role:"user",content:u,timestamp:Date.now()},C=a.value.get(r)||[];C.push(y),a.value.set(r,C);try{const v=await Ke.sendMessage({bot_id:r,message:u});if(v.code===0){const G={role:"assistant",content:v.data.reply,timestamp:Date.now()};return C.push(G),v.data.reply}return null}catch(v){throw console.error("Failed to send AI message:",v),v}finally{$.value=!1}},k=r=>{a.value.delete(r)},S=()=>{a.value.clear()},h=M([{id:9001,name:"智能助手",personality:"assistant",role:"assistant",tone:"friendly",is_default:!0},{id:9002,name:"聊天伙伴",personality:"companion",role:"companion",tone:"casual",is_default:!0},{id:9003,name:"学习导师",personality:"tutor",role:"tutor",tone:"professional",is_default:!0},{id:9004,name:"创意助手",personality:"creative",role:"creative",tone:"imaginative",is_default:!0}]);return{bots:g,currentBot:x,messages:a,loading:d,sending:$,defaultBots:h,loadBots:_,getBotMessages:T,setCurrentBot:F,sendMessage:p,clearMessages:k,clearAllMessages:S,getBotById:r=>g.value.find(u=>u.id===r)}}),tt=2,kt=3,St=5,st=7,bt=8,Ge=102,ze=16;function De(g,x,a,d){const $=d?new TextEncoder().encode(d):new Uint8Array(0),_=$.length,T=ze+_,F=new ArrayBuffer(T),p=new DataView(F),k=new Uint8Array(F);return p.setUint32(0,T,!1),p.setUint16(4,ze,!1),p.setUint16(6,g,!1),p.setUint32(8,x,!1),p.setUint32(12,a,!1),_>0&&k.set($,ze),F}function Ct(g){const x=new DataView(g),a=x.getUint32(0,!1),d=x.getUint16(4,!1),$=x.getUint16(6,!1),_=x.getUint32(8,!1),T=x.getUint32(12,!1),F=a-d;let p;if(F>0){const k=new Uint8Array(g,d,F);p=new TextDecoder().decode(k)}return{ver:$,op:_,seq:T,body:p}}function $t(g){switch(g){case tt:return"Heartbeat";case kt:return"Heartbeat Reply";case St:return"Message";case st:return"Auth";case bt:return"Auth Reply";default:return`Unknown(${g})`}}function Mt(g){const x=M("disconnected"),a=M(null),d=M([]);let $=1,_=null,T=null;const F=(y,C)=>{if(!a.value||a.value.readyState!==WebSocket.OPEN)return;const v=JSON.stringify({mid:C,key:`user_${C}`,room_id:"",platform:"web",accepts:[1001,1002,1003]}),G=De(Ge,st,$++,v);a.value.send(G),console.log("[WS] Auth sent")},p=()=>{if(!a.value||a.value.readyState!==WebSocket.OPEN)return;const y=De(Ge,tt,$++);a.value.send(y)},k=()=>{S(),_=window.setInterval(p,3e4)},S=()=>{_&&(clearInterval(_),_=null)},h=(y,C)=>{var v;if(((v=a.value)==null?void 0:v.readyState)!==WebSocket.OPEN){x.value="connecting";try{a.value=new WebSocket(g),a.value.binaryType="arraybuffer",a.value.onopen=()=>{console.log("[WS] Connected"),x.value="connected",F(y,C),k()},a.value.onmessage=G=>{const j=Ct(G.data);if(console.log("[WS] Received:",$t(j.op),j.seq,j.body),j.op===8)console.log("[WS] Auth success");else if(j.body)try{const z=JSON.parse(j.body);d.value.push(z)}catch{}},a.value.onclose=()=>{console.log("[WS] Disconnected"),x.value="disconnected",S(),T=window.setTimeout(()=>h(y,C),5e3)},a.value.onerror=G=>{console.error("[WS] Error:",G),x.value="error"}}catch(G){console.error("[WS] Connection error:",G),x.value="error"}}};return{status:x,messages:d,connect:h,disconnect:()=>{T&&(clearTimeout(T),T=null),S(),a.value&&(a.value.close(),a.value=null),x.value="disconnected"},send:(y,C)=>{if(!a.value||a.value.readyState!==WebSocket.OPEN)return console.error("[WS] Not connected"),!1;const v=De(Ge,y,$++,C);return a.value.send(v),!0},sendHeartbeat:p,clearMessages:()=>{d.value=[]}}}const ae=g=>g?typeof g=="string"?g:typeof g=="object"&&"String"in g?g.Valid?g.String:"":String(g):"",xt={class:"conversation-list"},Tt=["onClick"],Vt={class:"item-content"},Bt={class:"item-top"},Ut={class:"item-name"},Nt={class:"item-time"},Ft={class:"item-bottom"},At={class:"item-preview"},Gt=ye({__name:"ConversationList",emits:["select"],setup(g,{emit:x}){const a=x,d=Ee(),$=Fe(),_=Z(()=>d.currentSession?`${d.currentSession.targetId}:${d.currentSession.targetType==="group"?2:1}`:""),T=i=>{var u,y;const r=ae((u=i.target_user)==null?void 0:u.nickname);if(r)return r;if(i.conversation_type===1){const C=d.friends.find(v=>{var G;return((G=v.friend_user)==null?void 0:G.id)===i.target_id||v.friend_id===i.target_id});if(C)return C.remark||ae((y=C.friend_user)==null?void 0:y.nickname)||`User ${i.target_id}`}if(i.conversation_type===2){const C=$.getGroupById(i.target_id);return C?C.name:`Group ${i.target_id}`}return`User ${i.target_id}`},F=i=>{var u,y;const r=ae((u=i.target_user)==null?void 0:u.avatar);if(r)return r;if(i.conversation_type===1){const C=d.friends.find(v=>{var G;return((G=v.friend_user)==null?void 0:G.id)===i.target_id||v.friend_id===i.target_id});if(C)return ae((y=C.friend_user)==null?void 0:y.avatar)}if(i.conversation_type===2){const C=$.getGroupById(i.target_id);if(C)return ae(C.avatar)}return""},p=i=>{const r=ae(i.last_msg_content);if(!r)return"暂无消息";try{return JSON.parse(r).text||r}catch{return r}},k=i=>{if(!i)return"";const r=new Date(i);if(isNaN(r.getTime())){if(typeof i=="string"&&!isNaN(Number(i))){const u=Number(i),y=new Date(u<1e10?u*1e3:u);if(!isNaN(y.getTime()))return S(y)}return""}return S(r)},S=i=>{const r=new Date;return i.getDate()===r.getDate()&&i.getMonth()===r.getMonth()&&i.getFullYear()===r.getFullYear()?i.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):i.toLocaleDateString("zh-CN",{month:"numeric",day:"numeric"})},h=i=>{a("select",i)};return(i,r)=>{const u=b("el-avatar"),y=b("el-badge"),C=b("el-empty");return f(),N("div",xt,[(f(!0),N(le,null,ie(U(d).conversations,v=>(f(),N("div",{key:`${v.target_id}:${v.conversation_type}`,class:de(["list-item",{active:_.value===`${v.target_id}:${v.conversation_type}`}]),onClick:G=>h(v)},[e(u,{size:48,src:F(v),shape:"square",class:"item-avatar"},{default:s(()=>{var G;return[A(B(((G=T(v))==null?void 0:G[0])||"?"),1)]}),_:2},1032,["src"]),n("div",Vt,[n("div",Bt,[n("span",Ut,B(T(v)),1),n("span",Nt,B(k(v.last_msg_time)),1)]),n("div",Ft,[n("span",At,B(p(v)),1),v.unread_count>0?(f(),K(y,{key:0,value:v.unread_count>99?"99+":v.unread_count,class:"unread-badge"},null,8,["value"])):P("",!0)])])],10,Tt))),128)),U(d).conversations.length===0?(f(),K(C,{key:0,description:"暂无消息","image-size":60})):P("",!0)])}}}),zt=he(Gt,[["__scopeId","data-v-2695438a"]]),Dt={class:"friend-manager-container"},It={class:"friend-list-content"},Et={class:"list-header"},Lt={class:"friend-items"},Rt=["onClick"],qt={class:"friend-info"},Ot={class:"friend-name"},Wt={class:"friend-meta"},Ht={key:0,class:"friend-nickname"},Pt={class:"friend-group"},Kt={class:"requests-content"},jt={class:"request-items"},Jt={class:"request-info"},Yt={class:"request-name"},Zt={key:0,class:"request-message"},Qt={class:"request-time"},Xt={class:"request-actions"},es={class:"add-friend-content"},ts={key:0,class:"search-results"},ss={class:"user-info"},ns={class:"user-name"},as={class:"user-username"},os={class:"target-user"},rs=ye({__name:"FriendManager",setup(g){const x=Ee(),a=M("list"),d=M(""),$=M({keyword:""}),_=M([]),T=M(!1),F=M([]),p=M(!1),k=M({remark:"",groupName:""}),S=M(null),h=M(!1),i=M({message:""}),r=M(null),u=Z(()=>{if(!d.value)return x.friends;const V=d.value.toLowerCase();return x.friends.filter(o=>{var _e,ce;const R=ae((_e=o.friend_user)==null?void 0:_e.nickname).toLowerCase(),J=((ce=o.remark)==null?void 0:ce.toLowerCase())||"";return R.includes(V)||J.includes(V)})}),y=V=>ae(V==null?void 0:V.nickname),C=V=>{const o=new Date(V),J=new Date().getTime()-o.getTime();return J<6e4?"刚刚":J<36e5?`${Math.floor(J/6e4)} 分钟前`:J<864e5?`${Math.floor(J/36e5)} 小时前`:J<6048e5?`${Math.floor(J/864e5)} 天前`:o.toLocaleDateString("zh-CN")},v=()=>{},G=V=>{var R;const o=((R=V.friend_user)==null?void 0:R.id)||V.friend_id;x.openChat(o,1,V.remark||y(V.friend_user)||V.remark)},j=async(V,o)=>{var R;switch(V){case"chat":G(o);break;case"remark":S.value=o,k.value={remark:o.remark||((R=o.friend_user)==null?void 0:R.nickname)||"",groupName:o.group_name||""},p.value=!0;break;case"delete":await I(o);break}},z=async()=>{if(S.value)try{L.success("备注已更新"),p.value=!1,await x.loadFriends()}catch(V){L.error(V.message||"更新失败")}},I=async V=>{var o;try{await fe.confirm(`确定要删除好友 "${V.remark||((o=V.friend_user)==null?void 0:o.nickname)}" 吗？`,"删除好友",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await be.deleteFriend(V.id)).code===0&&(L.success("已删除好友"),await x.loadFriends())}catch(R){R!=="cancel"&&L.error(R.message||"删除失败")}},te=async()=>{if($.value.keyword.trim()){T.value=!0;try{const V=await Ye.searchUsers($.value.keyword);V.code===0&&(_.value=V.data.users||[])}catch(V){L.error(V.message||"搜索失败")}}},O=V=>{r.value=V,i.value.message="",h.value=!0},me=async()=>{if(r.value)try{(await be.sendRequest({to_user_id:r.value.id,message:i.value.message})).code===0&&(L.success("好友请求已发送"),h.value=!1,_.value=[])}catch(V){L.error(V.message||"发送失败")}},ue=async(V,o)=>{try{(await(o==="accept"?be.acceptRequest:be.rejectRequest)(V)).code===0&&(L.success(o==="accept"?"已接受好友请求":"已拒绝好友请求"),await re(),o==="accept"&&await x.loadFriends())}catch(R){L.error(R.message||"操作失败")}},re=async()=>{try{const V=await be.getRequests();V.code===0&&(F.value=(V.data.requests||[]).filter(o=>o.status===0))}catch(V){console.error("Failed to load friend requests:",V)}};return xe(async()=>{await x.loadFriends(),await re()}),(V,o)=>{const R=b("el-input"),J=b("el-avatar"),_e=b("MoreFilled"),ce=b("el-icon"),se=b("el-button"),pe=b("el-dropdown-item"),$e=b("el-dropdown-menu"),m=b("el-dropdown"),w=b("el-empty"),W=b("el-tab-pane"),X=b("el-badge"),Q=b("el-form-item"),Y=b("el-form"),c=b("el-tabs"),t=b("el-dialog");return f(),N("div",Dt,[e(c,{modelValue:a.value,"onUpdate:modelValue":o[2]||(o[2]=l=>a.value=l),class:"friend-tabs"},{default:s(()=>[e(W,{label:"好友列表",name:"list"},{default:s(()=>[n("div",It,[n("div",Et,[e(R,{modelValue:d.value,"onUpdate:modelValue":o[0]||(o[0]=l=>d.value=l),placeholder:"搜索好友","prefix-icon":U(Be),clearable:"",onInput:v},null,8,["modelValue","prefix-icon"])]),n("div",Lt,[(f(!0),N(le,null,ie(u.value,l=>{var D,E,H,oe;return f(),N("div",{key:l.id,class:"friend-item"},[n("div",{class:"friend-main",onClick:ve=>G(l)},[e(J,{size:48,src:(D=l.friend_user)==null?void 0:D.avatar},{default:s(()=>{var ve,we;return[A(B(((we=(ve=l.friend_user)==null?void 0:ve.nickname)==null?void 0:we[0])||"?"),1)]}),_:2},1032,["src"]),n("div",qt,[n("div",Ot,B(l.remark||((E=l.friend_user)==null?void 0:E.nickname)),1),n("div",Wt,[l.remark!==((H=l.friend_user)==null?void 0:H.nickname)?(f(),N("span",Ht," 昵称: "+B((oe=l.friend_user)==null?void 0:oe.nickname),1)):P("",!0),n("span",Pt,B(l.group_name||"默认分组"),1)])])],8,Rt),e(m,{trigger:"click",onCommand:ve=>j(ve,l)},{dropdown:s(()=>[e($e,null,{default:s(()=>[e(pe,{command:"chat"},{default:s(()=>[...o[10]||(o[10]=[A("发消息",-1)])]),_:1}),e(pe,{command:"remark"},{default:s(()=>[...o[11]||(o[11]=[A("设置备注",-1)])]),_:1}),e(pe,{command:"delete",divided:""},{default:s(()=>[...o[12]||(o[12]=[A("删除好友",-1)])]),_:1})]),_:1})]),default:s(()=>[e(se,{text:"",circle:""},{default:s(()=>[e(ce,null,{default:s(()=>[e(_e)]),_:1})]),_:1})]),_:1},8,["onCommand"])])}),128)),u.value.length===0?(f(),K(w,{key:0,description:"暂无好友"})):P("",!0)])])]),_:1}),e(W,{name:"requests"},{label:s(()=>[o[13]||(o[13]=n("span",null,"好友请求",-1)),F.value.length>0?(f(),K(X,{key:0,value:F.value.length,class:"request-badge"},null,8,["value"])):P("",!0)]),default:s(()=>[n("div",Kt,[n("div",jt,[(f(!0),N(le,null,ie(F.value,l=>{var D,E;return f(),N("div",{key:l.id,class:"request-item"},[e(J,{size:48,src:(D=l.from_user)==null?void 0:D.avatar},{default:s(()=>{var H,oe;return[A(B(((oe=(H=l.from_user)==null?void 0:H.nickname)==null?void 0:oe[0])||"?"),1)]}),_:2},1032,["src"]),n("div",Jt,[n("div",Yt,B((E=l.from_user)==null?void 0:E.nickname),1),l.message?(f(),N("div",Zt,B(l.message),1)):P("",!0),n("div",Qt,B(C(l.created_at)),1)]),n("div",Xt,[e(se,{type:"primary",size:"small",onClick:H=>ue(l.id,"accept")},{default:s(()=>[...o[14]||(o[14]=[A(" 接受 ",-1)])]),_:1},8,["onClick"]),e(se,{size:"small",onClick:H=>ue(l.id,"reject")},{default:s(()=>[...o[15]||(o[15]=[A(" 拒绝 ",-1)])]),_:1},8,["onClick"])])])}),128)),F.value.length===0?(f(),K(w,{key:0,description:"暂无好友请求"})):P("",!0)])])]),_:1}),e(W,{label:"添加好友",name:"add"},{default:s(()=>[n("div",es,[e(Y,{model:$.value,"label-position":"top"},{default:s(()=>[e(Q,{label:"搜索用户"},{default:s(()=>[e(R,{modelValue:$.value.keyword,"onUpdate:modelValue":o[1]||(o[1]=l=>$.value.keyword=l),placeholder:"输入用户名或昵称",onKeyup:Je(te,["enter"])},{append:s(()=>[e(se,{icon:U(Be),onClick:te},null,8,["icon"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"]),_.value.length>0?(f(),N("div",ts,[o[17]||(o[17]=n("div",{class:"results-title"},"搜索结果",-1)),(f(!0),N(le,null,ie(_.value,l=>(f(),N("div",{key:l.id,class:"user-item"},[e(J,{size:40,src:l.avatar},{default:s(()=>{var D;return[A(B(((D=l.nickname)==null?void 0:D[0])||"?"),1)]}),_:2},1032,["src"]),n("div",ss,[n("div",ns,B(l.nickname),1),n("div",as,"@"+B(l.username),1)]),e(se,{type:"primary",size:"small",onClick:D=>O(l)},{default:s(()=>[...o[16]||(o[16]=[A(" 添加 ",-1)])]),_:1},8,["onClick"])]))),128))])):T.value&&_.value.length===0?(f(),K(w,{key:1,description:"未找到用户"})):(f(),K(w,{key:2,description:"搜索用户来添加好友"}))])]),_:1})]),_:1},8,["modelValue"]),e(t,{modelValue:p.value,"onUpdate:modelValue":o[6]||(o[6]=l=>p.value=l),title:"设置备注",width:"400px"},{footer:s(()=>[e(se,{onClick:o[5]||(o[5]=l=>p.value=!1)},{default:s(()=>[...o[18]||(o[18]=[A("取消",-1)])]),_:1}),e(se,{type:"primary",onClick:z},{default:s(()=>[...o[19]||(o[19]=[A("保存",-1)])]),_:1})]),default:s(()=>[e(Y,{model:k.value,"label-width":"80px"},{default:s(()=>[e(Q,{label:"备注名"},{default:s(()=>[e(R,{modelValue:k.value.remark,"onUpdate:modelValue":o[3]||(o[3]=l=>k.value.remark=l),placeholder:"请输入备注名",maxlength:"50"},null,8,["modelValue"])]),_:1}),e(Q,{label:"分组"},{default:s(()=>[e(R,{modelValue:k.value.groupName,"onUpdate:modelValue":o[4]||(o[4]=l=>k.value.groupName=l),placeholder:"请输入分组名"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),e(t,{modelValue:h.value,"onUpdate:modelValue":o[9]||(o[9]=l=>h.value=l),title:"添加好友",width:"400px"},{footer:s(()=>[e(se,{onClick:o[8]||(o[8]=l=>h.value=!1)},{default:s(()=>[...o[20]||(o[20]=[A("取消",-1)])]),_:1}),e(se,{type:"primary",onClick:me},{default:s(()=>[...o[21]||(o[21]=[A("发送请求",-1)])]),_:1})]),default:s(()=>[e(Y,{model:i.value,"label-width":"80px"},{default:s(()=>[e(Q,{label:"对方"},{default:s(()=>{var l,D;return[n("div",os,[e(J,{size:32,src:(l=r.value)==null?void 0:l.avatar},{default:s(()=>{var E,H;return[A(B((H=(E=r.value)==null?void 0:E.nickname)==null?void 0:H[0]),1)]}),_:1},8,["src"]),n("span",null,B((D=r.value)==null?void 0:D.nickname),1)])]}),_:1}),e(Q,{label:"验证消息"},{default:s(()=>[e(R,{modelValue:i.value.message,"onUpdate:modelValue":o[7]||(o[7]=l=>i.value.message=l),type:"textarea",rows:3,placeholder:"请输入验证消息（可选）",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),ls=he(rs,[["__scopeId","data-v-c52824cc"]]),is={class:"group-list-container"},us={class:"list-header"},cs={class:"group-list"},ds=["onClick"],ms={class:"item-content"},_s={class:"item-name"},vs={class:"item-meta"},ps=ye({__name:"GroupList",emits:["select"],setup(g,{emit:x}){const a=x,d=Fe(),$=M(!1),_=M({name:"",max_members:100}),T=Z(()=>{var h;return(h=d.currentGroup)==null?void 0:h.id}),F={},p=h=>{if(!F[h]){const i=["#F56C6C","#E6A23C","#67C23A","#409EFF","#909399"];F[h]=i[h%i.length]}return F[h]},k=h=>{a("select",h)},S=async()=>{if(_.value.name.trim())try{const h=await d.createGroup({name:_.value.name,max_members:_.value.max_members});h&&(L.success("群组创建成功"),$.value=!1,_.value.name="",_.value.max_members=100,k(h))}catch(h){L.error(h.message||"创建失败")}};return xe(()=>{d.groups.length||d.loadGroups()}),(h,i)=>{const r=b("el-icon"),u=b("el-button"),y=b("el-skeleton"),C=b("el-avatar"),v=b("el-empty"),G=b("el-input"),j=b("el-form-item"),z=b("el-input-number"),I=b("el-form"),te=b("el-dialog");return f(),N("div",is,[n("div",us,[i[5]||(i[5]=n("div",{class:"list-title"},"我的群组",-1)),e(u,{type:"primary",size:"small",circle:"",onClick:i[0]||(i[0]=O=>$.value=!0)},{default:s(()=>[e(r,null,{default:s(()=>[e(U(Ze))]),_:1})]),_:1})]),n("div",cs,[U(d).loading?(f(),K(y,{key:0,rows:3,animated:"",class:"p-4"})):U(d).groups&&U(d).groups.length>0?(f(!0),N(le,{key:1},ie(U(d).groups.filter(O=>O!=null),O=>(f(),N("div",{key:O.id,class:de(["list-item",{active:T.value===O.id}]),onClick:me=>k(O)},[e(C,{size:48,style:Me({backgroundColor:p(O.id)}),shape:"square",class:"item-avatar"},{default:s(()=>[e(r,{size:"24",color:"white"},{default:s(()=>[e(U(Ne))]),_:1})]),_:1},8,["style"]),n("div",ms,[n("div",_s,B(O.name),1),n("div",vs,B(O.member_count)+" 成员",1)])],10,ds))),128)):(f(),K(v,{key:2,description:"暂无群组","image-size":60}))]),e(te,{modelValue:$.value,"onUpdate:modelValue":i[4]||(i[4]=O=>$.value=O),title:"创建群组",width:"400px","append-to-body":""},{footer:s(()=>[e(u,{onClick:i[3]||(i[3]=O=>$.value=!1)},{default:s(()=>[...i[6]||(i[6]=[A("取消",-1)])]),_:1}),e(u,{type:"primary",onClick:S,disabled:!_.value.name.trim()},{default:s(()=>[...i[7]||(i[7]=[A(" 创建 ",-1)])]),_:1},8,["disabled"])]),default:s(()=>[e(I,{model:_.value,"label-width":"80px"},{default:s(()=>[e(j,{label:"群名称"},{default:s(()=>[e(G,{modelValue:_.value.name,"onUpdate:modelValue":i[1]||(i[1]=O=>_.value.name=O),placeholder:"请输入群名称",maxlength:"50"},null,8,["modelValue"])]),_:1}),e(j,{label:"群人数"},{default:s(()=>[e(z,{modelValue:_.value.max_members,"onUpdate:modelValue":i[2]||(i[2]=O=>_.value.max_members=O),min:2,max:500},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),fs=he(ps,[["__scopeId","data-v-6c4a1f54"]]),gs={class:"bot-list-container"},ys={class:"bot-list"},hs=["onClick"],ws={class:"item-content"},ks={class:"item-name"},Ss={class:"item-desc"},bs=ye({__name:"BotList",emits:["select"],setup(g,{emit:x}){const a=x,d=et(),$=Z(()=>{var k;return(k=d.currentBot)==null?void 0:k.id}),_={9001:"#409EFF",9002:"#67C23A",9003:"#E6A23C",9004:"#F56C6C"},T=k=>_[k]||"#909399",F=k=>({assistant:"智能助手",companion:"聊天伙伴",tutor:"学习导师",creative:"创意助手"})[k]||"AI 助手",p=k=>{a("select",k)};return xe(()=>{d.bots.length||d.loadBots()}),(k,S)=>{const h=b("el-icon"),i=b("el-avatar");return f(),N("div",gs,[S[0]||(S[0]=n("div",{class:"list-header"},[n("div",{class:"list-title"},"AI 助手")],-1)),n("div",ys,[(f(!0),N(le,null,ie(U(d).bots,r=>(f(),N("div",{key:r.id,class:de(["list-item",{active:$.value===r.id}]),onClick:u=>p(r)},[e(i,{size:48,style:Me({backgroundColor:T(r.id)}),shape:"square",class:"item-avatar"},{default:s(()=>[e(h,{size:"24",color:"white"},{default:s(()=>[e(U(Ne))]),_:1})]),_:1},8,["style"]),n("div",ws,[n("div",ks,B(r.name),1),n("div",Ss,B(F(r.personality)),1)])],10,hs))),128))])])}}}),Cs=he(bs,[["__scopeId","data-v-9e51ef78"]]),$s={class:"chat-window"},Ms={class:"chat-header"},xs={class:"header-left"},Ts={class:"header-info"},Vs={class:"header-title"},Bs={key:0,class:"header-subtitle"},Us={class:"header-actions"},Ns={key:0,class:"loading-state"},Fs=["id"],As={key:0,class:"message-time-divider"},Gs={class:"message-row"},zs={class:"message-content-group"},Ds={key:0,class:"message-sender-name"},Is={key:0,class:"typing-indicator"},Es={key:1,class:"message-text"},Ls={key:2,class:"empty-state"},Rs={class:"input-area"},qs={class:"input-toolbar"},Os={class:"input-footer"},Ws=ye({__name:"ChatWindow",props:{messages:{},currentUserId:{},title:{},subtitle:{},avatar:{},avatarStyle:{},sending:{type:Boolean},loading:{type:Boolean},showSenderName:{type:Boolean},getSenderName:{type:Function},getSenderAvatar:{type:Function},getSenderStyle:{type:Function}},emits:["send"],setup(g,{expose:x,emit:a}){const d=g,$=a,_=M(""),T=M(),F=z=>z.from_user_id===d.currentUserId||z.role==="user",p=z=>{const I=ae(z);if(!I)return"";try{return JSON.parse(I).text||I}catch{return I}},k=(z,I)=>{if(!I)return!0;const te=new Date(z.timestamp||z.created_at).getTime(),O=new Date(I.timestamp||I.created_at).getTime();return te-O>5*60*1e3},S=z=>z?new Date(typeof z=="string"&&z.length<13?parseInt(z)*1e3:z).toLocaleString("zh-CN",{hour:"2-digit",minute:"2-digit",month:"short",day:"numeric"}):"",h=()=>{!_.value.trim()||d.sending||($("send",_.value),_.value="")},i=()=>{Ue(()=>{T.value&&(T.value.scrollTop=T.value.scrollHeight)})},r=z=>{Ue(()=>{const I=document.getElementById("msg-"+z);I&&I.scrollIntoView({behavior:"smooth",block:"center"})})};Ce(()=>d.messages,()=>{i()},{deep:!0}),xe(()=>{i()}),x({scrollToBottom:i,scrollToMessage:r});const u=z=>z.senderName||"User",y=z=>z.senderAvatar||"",C=z=>({}),v=d.getSenderName||u,G=d.getSenderAvatar||y,j=d.getSenderStyle||C;return(z,I)=>{const te=b("el-icon"),O=b("el-avatar"),me=b("el-skeleton"),ue=b("el-empty"),re=b("el-button"),V=b("el-input");return f(),N("div",$s,[n("div",Ms,[n("div",xs,[je(z.$slots,"header-prefix",{},void 0,!0),e(O,{size:40,src:g.avatar,style:Me(g.avatarStyle)},{default:s(()=>{var o;return[A(B(((o=g.title)==null?void 0:o[0])||"?")+" ",1),!g.title&&!g.avatar?(f(),K(te,{key:0},{default:s(()=>[e(U(it))]),_:1})):P("",!0)]}),_:1},8,["src","style"]),n("div",Ts,[n("div",Vs,B(g.title),1),g.subtitle?(f(),N("div",Bs,B(g.subtitle),1)):P("",!0)])]),n("div",Us,[je(z.$slots,"actions",{},void 0,!0)])]),n("div",{class:"messages-container",ref_key:"messagesRef",ref:T},[g.loading?(f(),N("div",Ns,[e(me,{rows:3,animated:""})])):(f(!0),N(le,{key:1},ie(g.messages,(o,R)=>(f(),N("div",{key:o.id||R,id:"msg-"+(o.msg_id||o.id),class:de(["message-wrapper",{"is-me":F(o)}])},[k(o,g.messages[R-1])?(f(),N("div",As,[n("span",null,B(S(o.timestamp||o.created_at)),1)])):P("",!0),n("div",Gs,[e(O,{class:"message-avatar",size:36,src:U(G)(o),style:Me(U(j)(o))},{default:s(()=>{var J;return[A(B(((J=U(v)(o))==null?void 0:J[0])||"?"),1)]}),_:2},1032,["src","style"]),n("div",zs,[!F(o)&&g.showSenderName?(f(),N("div",Ds,B(U(v)(o)),1)):P("",!0),n("div",{class:de(["message-bubble",{typing:o.isTyping}])},[o.isTyping?(f(),N("div",Is,[...I[1]||(I[1]=[n("span",null,null,-1),n("span",null,null,-1),n("span",null,null,-1)])])):(f(),N("div",Es,B(p(o.content)),1))],2)])])],10,Fs))),128)),g.messages.length===0&&!g.loading?(f(),N("div",Ls,[e(ue,{description:"暂无消息"})])):P("",!0)],512),n("div",Rs,[n("div",qs,[e(re,{text:"",circle:"",size:"small"},{default:s(()=>[e(te,null,{default:s(()=>[e(U(ut))]),_:1})]),_:1}),e(re,{text:"",circle:"",size:"small"},{default:s(()=>[e(te,null,{default:s(()=>[e(U(ct))]),_:1})]),_:1})]),e(V,{modelValue:_.value,"onUpdate:modelValue":I[0]||(I[0]=o=>_.value=o),type:"textarea",rows:3,placeholder:"输入消息...",resize:"none",onKeydown:Je(Qe(h,["exact","prevent"]),["enter"]),class:"chat-input"},null,8,["modelValue","onKeydown"]),n("div",Os,[I[3]||(I[3]=n("span",{class:"input-hint"},"Enter 发送，Shift + Enter 换行",-1)),e(re,{type:"primary",onClick:h,disabled:!_.value.trim()||g.sending,loading:g.sending},{default:s(()=>[...I[2]||(I[2]=[A(" 发送 ",-1)])]),_:1},8,["disabled","loading"])])])])}}}),Hs=he(Ws,[["__scopeId","data-v-32e7c7c3"]]),Ps={class:"group-sidebar"},Ks={class:"sidebar-close"},js={class:"group-info-section"},Js={class:"group-header"},Ys={class:"group-meta"},Zs={class:"group-name"},Qs={class:"group-no"},Xs={class:"group-stats"},en={class:"stat-item"},tn={class:"stat-value"},sn={class:"stat-item"},nn={class:"stat-value"},an={class:"group-actions"},on={class:"members-section"},rn={class:"section-header"},ln={class:"members-search"},un={class:"members-list"},cn={class:"member-info"},dn={class:"member-name"},mn={class:"member-id"},_n={class:"history-section"},vn={class:"history-search"},pn={class:"history-list"},fn=["onClick"],gn={class:"msg-header"},yn={class:"msg-sender"},hn={class:"msg-time"},wn={class:"msg-content"},kn={key:0,class:"empty-history"},Sn=ye({__name:"GroupSidebar",props:{group:{}},emits:["close","close-sidebar","scroll-to-message"],setup(g,{emit:x}){var Y;const a=g,d=x,$=Ve(),_=Fe(),T=M("info"),F=M(""),p=M(""),k=M(!1),S=M(!1),h=M(""),i=M(""),r=M(!1),u=M([]),y=M(!0),C=((Y=$.currentUser)==null?void 0:Y.id)||0,v=Z(()=>_.members),G=Z(()=>{var l;const c=["#F56C6C","#E6A23C","#67C23A","#409EFF","#909399"],t=((l=a.group)==null?void 0:l.id)||0;return c[t%c.length]}),j=c=>{var t;if(!c)return"未知";try{let l=ae(c.nickname)||ae((t=c.user)==null?void 0:t.nickname)||"";if(l&&l.startsWith("{"))try{return JSON.parse(l).String||"未知"}catch{return l}return l||"未知"}catch(l){return console.warn("Error parsing member name:",l),"未知"}},z=Z(()=>{const c=v.value.find(t=>t.role===3);return j(c)}),I=Z(()=>{var c;return((c=a.group)==null?void 0:c.owner_id)===C}),te=Z(()=>{const c=v.value.find(t=>t.user_id===C);return(c==null?void 0:c.role)===3||(c==null?void 0:c.role)===2}),O=Z(()=>{if(!F.value)return v.value;const c=F.value.toLowerCase();return v.value.filter(t=>j(t).toLowerCase().includes(c)||t.user_id.toString().includes(c))}),me=Z(()=>v.value.filter(c=>c.role===2||c.role===3)),ue=Z(()=>{if(!p.value)return u.value;const c=p.value.toLowerCase();return u.value.filter(t=>o(t.content).toLowerCase().includes(c))}),re=c=>{var l;if(c.from_user_id===C)return"我";const t=v.value.find(D=>D.user_id===c.from_user_id);return(t==null?void 0:t.nickname)||((l=t==null?void 0:t.user)==null?void 0:l.nickname)||`用户${c.from_user_id}`},V=c=>{const t=new Date(c),D=new Date().getTime()-t.getTime(),E=Math.floor(D/(1e3*60*60*24));return E===0?t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):E===1?"昨天 "+t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):E<7?["周日","周一","周二","周三","周四","周五","周六"][t.getDay()]+" "+t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},o=c=>{try{return JSON.parse(c).text||c}catch{return c}},R=async()=>{var c;if(!(!a.group||p.value.length<2)){r.value=!0;try{const t=await ge.getHistory({conversation_id:a.group.id,conversation_type:2,limit:100});t.code===0&&(u.value=((c=t.data)==null?void 0:c.messages)||[])}catch(t){console.error("Failed to search messages:",t)}finally{r.value=!1}}},J=async()=>{var t;if(!a.group||u.value.length===0)return;const c=u.value[u.value.length-1].seq;r.value=!0;try{const l=await ge.getHistory({conversation_id:a.group.id,conversation_type:2,last_seq:c,limit:50});if(l.code===0){const D=((t=l.data)==null?void 0:t.messages)||[];u.value.push(...D),y.value=D.length>=50}}catch(l){console.error("Failed to load more history:",l)}finally{r.value=!1}},_e=c=>{d("scroll-to-message",c)},ce=async()=>{var c;if(a.group){if(!h.value){L.warning("请输入用户ID");return}try{const D=(((c=(await Ye.searchUsers(h.value)).data)==null?void 0:c.users)||[]).find(H=>H.id===Number(h.value));if(!D){L.warning("用户不存在");return}const E=await ne.invite(a.group.id,{user_id:D.id});E.code===0?(L.success("邀请成功"),k.value=!1,h.value="",await _.loadMembers(a.group.id)):L.error(E.message||"邀请失败")}catch(t){L.error(t.message||"邀请失败")}}},se=async()=>{if(a.group)try{await fe.confirm("确定要退出群聊吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await ne.leave(a.group.id)).code===0&&(L.success("已退出群聊"),d("close"))}catch(c){c!=="cancel"&&L.error(c.message||"操作失败")}},pe=async()=>{if(a.group)try{await fe.confirm("确定要解散群聊吗？此操作不可恢复！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await ne.deleteGroup(a.group.id)).code===0&&(L.success("群聊已解散"),d("close"))}catch(c){c!=="cancel"&&L.error(c.message||"操作失败")}},$e=()=>{i.value="",S.value=!0},m=async()=>{if(a.group){if(!i.value){L.warning("请选择新群主");return}try{await fe.confirm(`确定要将群主转让给用户 ${i.value} 吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await ne.transferOwnership(a.group.id,Number(i.value))).code===0&&(L.success("群主已转让"),S.value=!1,d("close"))}catch(c){c!=="cancel"&&L.error(c.message||"操作失败")}}},w=async c=>{if(a.group)try{const{value:t}=await fe.prompt("请输入群昵称","设置昵称",{confirmButtonText:"确定",cancelButtonText:"取消",inputValue:c.nickname||"",inputPattern:/^.{1,20}$/,inputErrorMessage:"昵称长度为1-20个字符"});(await ne.setMemberNickname(a.group.id,c.user_id,t)).code===0&&(L.success("昵称已设置"),await _.loadMembers(a.group.id))}catch(t){t!=="cancel"&&L.error(t.message||"操作失败")}},W=async c=>{if(a.group)try{const t=c.role===2?1:2;(await ne.setMemberRole(a.group.id,c.user_id,t)).code===0&&(L.success("角色已更新"),await _.loadMembers(a.group.id))}catch(t){L.error(t.message||"操作失败")}},X=async c=>{if(a.group)try{const t=c.mute_until?-1:60;(await ne.muteMember(a.group.id,c.user_id,t)).code===0&&(L.success(t>0?"已禁言60分钟":"已解除禁言"),await _.loadMembers(a.group.id))}catch(t){L.error(t.message||"操作失败")}},Q=async c=>{var t;if(a.group)try{await fe.confirm(`确定要将 ${c.nickname||((t=c.user)==null?void 0:t.nickname)} 移出群聊吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await ne.kick(a.group.id,c.user_id)).code===0&&(L.success("成员已移除"),await _.loadMembers(a.group.id))}catch(l){l!=="cancel"&&L.error(l.message||"操作失败")}};return Ce(()=>a.group,async c=>{var t;if(c){await _.loadMembers(c.id);const l=await ge.getHistory({conversation_id:c.id,conversation_type:2,limit:50});l.code===0&&(u.value=((t=l.data)==null?void 0:t.messages)||[])}},{immediate:!0}),(c,t)=>{const l=b("el-icon"),D=b("el-button"),E=b("el-avatar"),H=b("el-dropdown-item"),oe=b("el-dropdown-menu"),ve=b("el-dropdown"),we=b("el-input"),Le=b("el-tag"),Re=b("el-tab-pane"),nt=b("el-tabs"),qe=b("el-dialog"),at=b("el-option"),ot=b("el-select"),rt=_t("loading");return f(),N("div",Ps,[n("div",Ks,[e(D,{text:"",circle:"",onClick:t[0]||(t[0]=q=>d("close-sidebar"))},{default:s(()=>[e(l,null,{default:s(()=>[e(U(dt))]),_:1})]),_:1})]),e(nt,{modelValue:T.value,"onUpdate:modelValue":t[4]||(t[4]=q=>T.value=q),class:"sidebar-tabs"},{default:s(()=>[e(Re,{label:"群信息",name:"info"},{default:s(()=>{var q,ke,Oe,We;return[n("div",js,[n("div",Js,[e(E,{size:60,src:(q=g.group)==null?void 0:q.avatar,style:Me({backgroundColor:G.value}),shape:"square"},{default:s(()=>[e(l,{size:"30",color:"white"},{default:s(()=>[e(U(Ne))]),_:1})]),_:1},8,["src","style"]),n("div",Ys,[n("h3",Zs,B((ke=g.group)==null?void 0:ke.name),1),n("p",Qs,"群号: "+B(((Oe=g.group)==null?void 0:Oe.id)||"未设置"),1)])]),n("div",Xs,[n("div",en,[t[11]||(t[11]=n("span",{class:"stat-label"},"群主",-1)),n("span",tn,B(z.value),1)]),n("div",sn,[t[12]||(t[12]=n("span",{class:"stat-label"},"成员",-1)),n("span",nn,B(v.value.length)+"/"+B(((We=g.group)==null?void 0:We.max_members)||500),1)])]),n("div",an,[te.value?(f(),K(D,{key:0,type:"primary",size:"small",onClick:t[1]||(t[1]=ee=>k.value=!0)},{default:s(()=>[e(l,null,{default:s(()=>[e(U(Ze))]),_:1}),t[13]||(t[13]=A(" 邀请成员 ",-1))]),_:1})):P("",!0),I.value?P("",!0):(f(),K(D,{key:1,type:"danger",size:"small",onClick:se},{default:s(()=>[...t[14]||(t[14]=[A(" 退出群聊 ",-1)])]),_:1})),I.value?(f(),K(ve,{key:2,trigger:"click"},{dropdown:s(()=>[e(oe,null,{default:s(()=>[e(H,{onClick:$e},{default:s(()=>[...t[16]||(t[16]=[A("转让群主",-1)])]),_:1}),e(H,{onClick:pe,style:{color:"#f56c6c"}},{default:s(()=>[...t[17]||(t[17]=[A("解散群聊",-1)])]),_:1})]),_:1})]),default:s(()=>[e(D,{size:"small"},{default:s(()=>[t[15]||(t[15]=A(" 更多 ",-1)),e(l,null,{default:s(()=>[e(U(mt))]),_:1})]),_:1})]),_:1})):P("",!0)])]),n("div",on,[n("div",rn,[n("span",null,"群成员 ("+B(v.value.length)+")",1)]),n("div",ln,[e(we,{modelValue:F.value,"onUpdate:modelValue":t[2]||(t[2]=ee=>F.value=ee),placeholder:"搜索成员","prefix-icon":U(Be),size:"small",clearable:""},null,8,["modelValue","prefix-icon"])]),n("div",un,[(f(!0),N(le,null,ie(O.value,ee=>{var He;return f(),N("div",{key:ee.user_id,class:"member-item"},[e(E,{size:36,src:(He=ee.user)==null?void 0:He.avatar},{default:s(()=>{var Se,Pe;return[A(B(((Pe=(Se=ee.user)==null?void 0:Se.nickname)==null?void 0:Pe[0])||"?"),1)]}),_:2},1032,["src"]),n("div",cn,[n("div",dn,[A(B(j(ee))+" ",1),ee.role===3?(f(),K(Le,{key:0,size:"small",type:"danger"},{default:s(()=>[...t[18]||(t[18]=[A("群主",-1)])]),_:1})):P("",!0),ee.role===2?(f(),K(Le,{key:1,size:"small",type:"warning"},{default:s(()=>[...t[19]||(t[19]=[A("管理员",-1)])]),_:1})):P("",!0)]),n("div",mn,"ID: "+B(ee.user_id),1)]),te.value&&ee.user_id!==U(C)?(f(),K(ve,{key:0,trigger:"click"},{dropdown:s(()=>[e(oe,null,{default:s(()=>[e(H,{onClick:Se=>w(ee)},{default:s(()=>[...t[20]||(t[20]=[A("设置昵称",-1)])]),_:1},8,["onClick"]),I.value?(f(),K(H,{key:0,onClick:Se=>W(ee)},{default:s(()=>[A(" 设为"+B(ee.role===2?"普通成员":"管理员"),1)]),_:2},1032,["onClick"])):P("",!0),e(H,{onClick:Se=>X(ee)},{default:s(()=>[A(B(ee.mute_until?"解除禁言":"禁言"),1)]),_:2},1032,["onClick"]),e(H,{onClick:Se=>Q(ee),style:{color:"#f56c6c"}},{default:s(()=>[...t[21]||(t[21]=[A(" 移除成员 ",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),default:s(()=>[e(D,{text:"",circle:"",size:"small"},{default:s(()=>[e(l,null,{default:s(()=>[e(U(Xe))]),_:1})]),_:1})]),_:2},1024)):P("",!0)])}),128))])])]}),_:1}),e(Re,{label:"历史消息",name:"history"},{default:s(()=>[n("div",_n,[n("div",vn,[e(we,{modelValue:p.value,"onUpdate:modelValue":t[3]||(t[3]=q=>p.value=q),placeholder:"搜索消息内容","prefix-icon":U(Be),size:"small",clearable:"",onInput:R},null,8,["modelValue","prefix-icon"])]),Te((f(),N("div",pn,[(f(!0),N(le,null,ie(ue.value,q=>(f(),N("div",{key:q.id,class:"history-message",onClick:ke=>_e(q)},[n("div",gn,[n("span",yn,B(re(q)),1),n("span",hn,B(V(q.created_at)),1)]),n("div",wn,B(o(q.content)),1)],8,fn))),128)),ue.value.length===0&&!r.value?(f(),N("div",kn," 暂无历史消息 ")):P("",!0),y.value?(f(),N("div",{key:1,class:"load-more",onClick:J}," 加载更多 ")):P("",!0)])),[[rt,r.value]])])]),_:1})]),_:1},8,["modelValue"]),e(qe,{modelValue:k.value,"onUpdate:modelValue":t[7]||(t[7]=q=>k.value=q),title:"邀请成员",width:"400px"},{footer:s(()=>[e(D,{onClick:t[6]||(t[6]=q=>k.value=!1)},{default:s(()=>[...t[22]||(t[22]=[A("取消",-1)])]),_:1}),e(D,{type:"primary",onClick:ce},{default:s(()=>[...t[23]||(t[23]=[A("邀请",-1)])]),_:1})]),default:s(()=>[e(we,{modelValue:h.value,"onUpdate:modelValue":t[5]||(t[5]=q=>h.value=q),placeholder:"输入用户ID或用户名",clearable:""},null,8,["modelValue"])]),_:1},8,["modelValue"]),e(qe,{modelValue:S.value,"onUpdate:modelValue":t[10]||(t[10]=q=>S.value=q),title:"转让群主",width:"400px"},{footer:s(()=>[e(D,{onClick:t[9]||(t[9]=q=>S.value=!1)},{default:s(()=>[...t[24]||(t[24]=[A("取消",-1)])]),_:1}),e(D,{type:"primary",onClick:m},{default:s(()=>[...t[25]||(t[25]=[A("确认转让",-1)])]),_:1})]),default:s(()=>[e(ot,{modelValue:i.value,"onUpdate:modelValue":t[8]||(t[8]=q=>i.value=q),placeholder:"选择新群主",style:{width:"100%"}},{default:s(()=>[(f(!0),N(le,null,ie(me.value,q=>{var ke;return f(),K(at,{key:q.user_id,label:q.nickname||((ke=q.user)==null?void 0:ke.nickname),value:q.user_id},null,8,["label","value"])}),128))]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])])}}}),bn=he(Sn,[["__scopeId","data-v-dc1dcf58"]]),Cn={class:"main-layout"},$n={class:"icon-sidebar"},Mn={class:"app-logo"},xn={class:"nav-items"},Tn={class:"bottom-actions"},Vn={class:"user-dropdown-header"},Bn={class:"dropdown-name"},Un={class:"list-sidebar"},Nn={class:"sidebar-search"},Fn={class:"sidebar-content"},An={class:"main-content"},Gn={key:0,class:"chat-container"},zn={class:"header-actions-wrapper"},Dn={key:0,class:"sidebar-wrapper"},In={key:1,class:"empty-state"},En=ye({__name:"Main",setup(g){const x=wt(),a=Ve(),d=Ee(),$=Fe(),_=et(),T=M("chats"),F=M(""),p=M(null),k=M(!1),S=M(),{messages:h,connect:i,disconnect:r}=Mt("ws://localhost:3102/sub"),u=Z(()=>{var m;return p.value==="ai"?_.currentBot?_.getBotMessages(_.currentBot.id):[]:((m=d.currentSession)==null?void 0:m.messages)||[]}),y=Z(()=>{var m,w;return p.value==="ai"?((m=_.currentBot)==null?void 0:m.name)||"AI":((w=d.currentSession)==null?void 0:w.name)||"Chat"}),C=Z(()=>{var m;return p.value==="ai"?((m=_.currentBot)==null?void 0:m.personality)||"Assistant":p.value==="group"?`${$.members.length} members`:"Online"}),v=Z(()=>{var m;return p.value==="ai"?"":(m=d.currentSession)==null?void 0:m.avatar}),G=Z(()=>{var m;if(p.value==="ai"&&_.currentBot)return{backgroundColor:{9001:"#409EFF",9002:"#67C23A",9003:"#E6A23C",9004:"#F56C6C"}[_.currentBot.id]||"#909399"};if(p.value==="group"){const w=["#F56C6C","#E6A23C","#67C23A","#409EFF","#909399"],W=((m=d.currentSession)==null?void 0:m.targetId)||0;return{backgroundColor:w[W%w.length]}}return{}}),j=Z(()=>p.value==="ai"?_.sending:!1),z=Z(()=>!1),I=async m=>{var X,Q;console.log("handleConversationSelect:",m.conversation_type,"current activeSessionType:",p.value),k.value=!1,console.log("set showGroupSidebar to false"),await Ue(),p.value=m.conversation_type===2?"group":"private";const w=ae((X=m.target_user)==null?void 0:X.nickname),W=ae((Q=m.target_user)==null?void 0:Q.avatar);await d.openChat(m.target_id,m.conversation_type,w,W),p.value==="group"&&await ce(m.target_id),console.log("after handleConversationSelect, activeSessionType:",p.value,"showGroupSidebar:",k.value)},te=m=>{var W,X;console.log("handleFriendChat"),k.value=!1,console.log("set showGroupSidebar to false");const w=((W=m.friend_user)==null?void 0:W.id)||m.friend_id;p.value="private",d.openChat(w,1,m.remark||((X=m.friend_user)==null?void 0:X.nickname)),T.value="chats",console.log("after handleFriendChat, activeSessionType:",p.value,"showGroupSidebar:",k.value)},O=async m=>{console.log("handleGroupSelect"),k.value=!1,console.log("set showGroupSidebar to false"),await Ue(),p.value="group",await $.setCurrentGroup(m),d.openChat(m.id,2,m.name),await ce(m.id),console.log("after handleGroupSelect, activeSessionType:",p.value,"showGroupSidebar:",k.value)},me=m=>{console.log("handleBotSelect"),p.value="ai",k.value=!1,_.setCurrentBot(m),console.log("after handleBotSelect, activeSessionType:",p.value,"showGroupSidebar:",k.value)},ue=()=>{k.value=!k.value},re=async m=>{if(p.value==="ai")_.currentBot&&await _.sendMessage(_.currentBot.id,m);else{const w=p.value==="group"?2:1;await d.sendMessage(JSON.stringify({text:m}),w)}},V=async()=>{try{await fe.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),r(),a.logout(),x.push("/login")}catch{}},o=async()=>{k.value=!1,$.clearCurrentGroup(),p.value=null,await d.loadConversations()},R=m=>{const w=m.msg_id||m.id;S.value&&w&&S.value.scrollToMessage(w)},J=async()=>{_.currentBot&&_.clearMessages(_.currentBot.id)},_e=M(new Map),ce=async m=>{_e.value.has(m)||await $.loadGroups()},se=m=>{var w,W,X,Q;if(m.role)return m.role==="user"?"我":((w=_.currentBot)==null?void 0:w.name)||"AI";if(m.from_user_id===((W=a.currentUser)==null?void 0:W.id))return"我";if(p.value==="group"){const Y=$.members.find(c=>c.user_id===m.from_user_id);return((X=Y==null?void 0:Y.user)==null?void 0:X.nickname)||(Y==null?void 0:Y.nickname)||`User ${m.from_user_id}`}return((Q=d.currentSession)==null?void 0:Q.name)||"User"},pe=m=>{var w,W,X,Q;if(m.role==="assistant")return"";if(m.from_user_id===((w=a.currentUser)==null?void 0:w.id))return((W=a.currentUser)==null?void 0:W.avatar)||"";if(p.value==="group"){const Y=$.members.find(c=>c.user_id===m.from_user_id);return((X=Y==null?void 0:Y.user)==null?void 0:X.avatar)||""}return((Q=d.currentSession)==null?void 0:Q.avatar)||""},$e=m=>m.role==="assistant"&&_.currentBot?G.value:{};return xe(async()=>{if(a.isLoggedIn){await Promise.all([d.loadConversations(),d.loadFriends()]);try{i(a.token,a.currentUser.id)}catch(m){console.warn("WS failed",m)}}}),Ce(p,(m,w)=>{console.log("activeSessionType changed from",w,"to",m),m!=="group"&&(k.value=!1,console.log("auto-close sidebar because newType is not group"))}),Ce(h,m=>{if(m.length>0){const w=m[m.length-1];(w.conversation_type===1||w.conversation_type===2)&&d.addMessage({id:Date.now(),msg_id:w.msg_id,from_user_id:w.from_user_id,conversation_id:w.conversation_id,conversation_type:w.conversation_type,msg_type:w.msg_type,content:w.content,seq:w.seq,created_at:new Date(w.created_at).toISOString()})}}),Ce(T,()=>{k.value=!1}),Ce(()=>{var m;return(m=d.currentSession)==null?void 0:m.id},()=>{k.value=!1}),(m,w)=>{var D;const W=b("el-icon"),X=b("el-avatar"),Q=b("el-dropdown-item"),Y=b("el-dropdown-menu"),c=b("el-dropdown"),t=b("el-input"),l=b("el-button");return f(),N("div",Cn,[n("div",$n,[n("div",Mn,[e(W,{size:32,color:"#6366f1"},{default:s(()=>[e(U(Ne))]),_:1})]),n("div",xn,[n("div",{class:de(["nav-item",{active:T.value==="chats"}]),onClick:w[0]||(w[0]=E=>T.value="chats"),title:"聊天"},[e(W,{size:24},{default:s(()=>[e(U(vt))]),_:1})],2),n("div",{class:de(["nav-item",{active:T.value==="friends"}]),onClick:w[1]||(w[1]=E=>T.value="friends"),title:"好友"},[e(W,{size:24},{default:s(()=>[e(U(pt))]),_:1})],2),n("div",{class:de(["nav-item",{active:T.value==="groups"}]),onClick:w[2]||(w[2]=E=>T.value="groups"),title:"群组"},[e(W,{size:24},{default:s(()=>[e(U(ft))]),_:1})],2),n("div",{class:de(["nav-item",{active:T.value==="ai"}]),onClick:w[3]||(w[3]=E=>T.value="ai"),title:"AI 助手"},[e(W,{size:24},{default:s(()=>[e(U(gt))]),_:1})],2)]),n("div",Tn,[e(c,{trigger:"click",placement:"right-end"},{dropdown:s(()=>[e(Y,null,{default:s(()=>{var E;return[n("div",Vn,[n("div",Bn,B((E=U(a).currentUser)==null?void 0:E.nickname),1),w[6]||(w[6]=n("div",{class:"dropdown-status"},"在线",-1))]),e(Q,{divided:"",onClick:V},{default:s(()=>[e(W,null,{default:s(()=>[e(U(yt))]),_:1}),w[7]||(w[7]=A("退出登录 ",-1))]),_:1})]}),_:1})]),default:s(()=>{var E;return[e(X,{size:40,src:(E=U(a).currentUser)==null?void 0:E.avatar,class:"user-avatar"},{default:s(()=>{var H,oe;return[A(B((oe=(H=U(a).currentUser)==null?void 0:H.nickname)==null?void 0:oe[0]),1)]}),_:1},8,["src"])]}),_:1})])]),n("div",Un,[n("div",Nn,[e(t,{modelValue:F.value,"onUpdate:modelValue":w[4]||(w[4]=E=>F.value=E),placeholder:"搜索...","prefix-icon":"Search",class:"custom-input"},null,8,["modelValue"])]),n("div",Fn,[T.value==="chats"?(f(),K(zt,{key:0,onSelect:I})):T.value==="friends"?(f(),K(ls,{key:1,onChat:te})):T.value==="groups"?(f(),K(fs,{key:2,onSelect:O})):T.value==="ai"?(f(),K(Cs,{key:3,onSelect:me})):P("",!0)])]),n("div",An,[p.value?(f(),N("div",Gn,[e(Hs,{ref_key:"chatWindowRef",ref:S,messages:u.value,"current-user-id":((D=U(a).currentUser)==null?void 0:D.id)||0,title:y.value,subtitle:C.value,avatar:v.value,"avatar-style":G.value,sending:j.value,loading:z.value,"show-sender-name":p.value==="group","get-sender-name":se,"get-sender-avatar":pe,"get-sender-style":$e,onSend:re},{actions:s(()=>[n("div",zn,[Te(e(l,{key:"group-btn",text:"",circle:"",onClick:Qe(ue,["stop"])},{default:s(()=>[e(W,null,{default:s(()=>[e(U(Xe))]),_:1})]),_:1},512),[[Ae,p.value==="group"]]),Te(e(l,{key:"ai-btn",text:"",circle:"",onClick:J},{default:s(()=>[e(W,null,{default:s(()=>[e(U(ht))]),_:1})]),_:1},512),[[Ae,p.value==="ai"]])])]),_:1},8,["messages","current-user-id","title","subtitle","avatar","avatar-style","sending","loading","show-sender-name"]),p.value==="group"&&U($).currentGroup?(f(),N("div",Dn,[Te((f(),K(bn,{key:U($).currentGroup.id,group:U($).currentGroup,onCloseSidebar:w[5]||(w[5]=E=>k.value=!1),onClose:o,onScrollToMessage:R},null,8,["group"])),[[Ae,k.value]])])):P("",!0)])):(f(),N("div",In,[...w[8]||(w[8]=[n("div",{class:"empty-content"},[n("img",{src:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?prompt=minimalist%20chat%20illustration%20vector%20flat%20design%20blue&image_size=square_hd",alt:"Empty State",class:"empty-img"}),n("h3",null,"开始聊天"),n("p",null,"选择一个联系人或群组开始对话")],-1)])]))])])}}}),Rn=he(En,[["__scopeId","data-v-0f6a6055"]]);export{Rn as default};
