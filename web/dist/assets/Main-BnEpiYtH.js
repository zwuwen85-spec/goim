import{p as $e,r as B,q as Ie,s as ue,v as ye,u as Ce,x as fe,y as Ue,d as de,z as J,c as V,o as k,A as L,B as O,F as oe,g as re,C as ee,e,b as a,w as o,m as E,t as N,f as $,j as F,_ as me,D as ge,G as Fe,i as Ne,E as j,H as Te,I as Re,J as Le,K as Me,L as he,M as Ge,N as Ve,O as qe,P as Oe,Q as We,R as Pe,S as He,T as Ke,k as je,U as Je,V as Ye,W as Qe,X as Xe,Y as Ze,h as et}from"./index-CGNwXxFr.js";const Be=$e("chat",()=>{const m=B([]),S=B([]),n=B(null),i=B(new Map);B(new Map);const w=async()=>{const h=await Ie.getList();h.data.code===0&&(m.value=h.data.conversations||[])};return{conversations:m,friends:S,currentSession:n,sessions:i,loadConversations:w,loadFriends:async()=>{const h=await ue.getFriends();h.data.code===0&&(S.value=h.data.friends||[])},openChat:async(h,y,s,t)=>{var b;const l=`${h}:${y}`;if(!i.value.has(l)){const g=await ye.getHistory({conversation_id:h,conversation_type:y,limit:50}),v={id:l,targetId:h,targetType:y===1?"user":"group",name:s||`Chat ${h}`,avatar:t,unreadCount:0,messages:((b=g.data)==null?void 0:b.messages)||[]};i.value.set(l,v)}n.value=i.value.get(l);const d=m.value.find(g=>g.target_id===h&&g.conversation_type===y);if(d&&d.unread_count>0){const g=i.value.get(l);if(g&&g.messages.length>0){const v=g.messages[g.messages.length-1];await ye.markRead({conversation_id:h,conversation_type:y,msg_id:v.id}),d.unread_count=0}}},sendMessage:async(h,y=1)=>{var d;if(!n.value)return!1;const t=((d=Ce().currentUser)==null?void 0:d.id)||0,l=await ye.send({to_user_id:n.value.targetType==="user"?n.value.targetId:void 0,to_group_id:n.value.targetType==="group"?n.value.targetId:void 0,conversation_type:n.value.targetType==="user"?1:2,msg_type:y,content:h});if(l.data.code===0){const b={id:Date.now(),msg_id:l.data.msg_id,from_user_id:t,conversation_id:l.data.conversation_id,conversation_type:l.data.conversation_type,msg_type:y,content:h,seq:l.data.seq,created_at:l.data.created_at};return n.value.messages.push(b),!0}return!1},addMessage:h=>{const y=`${h.conversation_id}:${h.conversation_type}`;let s=i.value.get(y);s||(s={id:y,targetId:h.conversation_id,targetType:h.conversation_type===1?"user":"group",name:`Chat ${h.conversation_id}`,unreadCount:0,messages:[]},i.value.set(y,s)),s.messages.push(h),w()},getSessionKey:h=>{var d;const s=((d=Ce().currentUser)==null?void 0:d.id)||0,t=Math.min(s,h),l=Math.max(s,h);return`${t*1e9+l}:1`}}}),Ae=$e("group",()=>{const m=B([]),S=B(null),n=B([]),i=B(!1),w=async()=>{i.value=!0;try{const t=await fe.getList();if(t.code===0){const l=t.data.groups||[];m.value=l.filter(d=>d!=null&&d.id!=null)}else m.value=[]}catch(t){throw console.error("Failed to load groups:",t),m.value=[],t}finally{i.value=!1}},u=async t=>{i.value=!0;try{const l=await fe.create(t);if(l.code===0){const d=l.data.group;return m.value.push(d),d}return null}catch(l){throw console.error("Failed to create group:",l),l}finally{i.value=!1}},M=async t=>{S.value=t,await x(t.id)},x=async t=>{try{const l=await fe.getMembers(t);if(l.code===0){const d=l.data.members||[];n.value=d.filter(b=>b!=null&&b.id!=null)}else n.value=[]}catch(l){throw console.error("Failed to load members:",l),n.value=[],l}};return{groups:m,currentGroup:S,members:n,loading:i,loadGroups:w,createGroup:u,setCurrentGroup:M,loadMembers:x,joinGroup:async(t,l)=>{try{return(await fe.join(t,l)).code===0?(await w(),!0):!1}catch(d){throw console.error("Failed to join group:",d),d}},leaveGroup:async t=>{var l;try{return(await fe.leave(t)).code===0?(m.value=m.value.filter(b=>b.id!==t),((l=S.value)==null?void 0:l.id)===t&&(S.value=null,n.value=[]),!0):!1}catch(d){throw console.error("Failed to leave group:",d),d}},sendMessage:async(t,l)=>{try{return(await ye.send({to_group_id:t,conversation_type:2,msg_type:1,content:JSON.stringify({text:l})})).code===0}catch(d){throw console.error("Failed to send message:",d),d}},getGroupById:t=>m.value.find(l=>l.id===t),clearCurrentGroup:()=>{S.value=null,n.value=[]}}}),ze=$e("ai",()=>{const m=B([]),S=B(null),n=B(new Map),i=B(!1),w=B(!1),u=async()=>{try{const t=await Ue.getBots();t.code===0&&(m.value=t.data.bots||[])}catch(t){throw console.error("Failed to load AI bots:",t),t}},M=t=>n.value.get(t)||[],x=t=>{S.value=t,n.value.has(t.id)||n.value.set(t.id,[])},f=async(t,l)=>{if(!l.trim())return null;w.value=!0;const d={role:"user",content:l,timestamp:Date.now()},b=n.value.get(t)||[];b.push(d),n.value.set(t,b);try{const g=await Ue.sendMessage({bot_id:t,message:l});if(g.code===0){const v={role:"assistant",content:g.data.reply,timestamp:Date.now()};return b.push(v),g.data.reply}return null}catch(g){throw console.error("Failed to send AI message:",g),g}finally{w.value=!1}},A=t=>{n.value.delete(t)},h=()=>{n.value.clear()},y=B([{id:9001,name:"智能助手",personality:"assistant",role:"assistant",tone:"friendly",is_default:!0},{id:9002,name:"聊天伙伴",personality:"companion",role:"companion",tone:"casual",is_default:!0},{id:9003,name:"学习导师",personality:"tutor",role:"tutor",tone:"professional",is_default:!0},{id:9004,name:"创意助手",personality:"creative",role:"creative",tone:"imaginative",is_default:!0}]);return{bots:m,currentBot:S,messages:n,loading:i,sending:w,defaultBots:y,loadBots:u,getBotMessages:M,setCurrentBot:x,sendMessage:f,clearMessages:A,clearAllMessages:h,getBotById:t=>m.value.find(l=>l.id===t)}}),De=2,tt=3,st=5,Ee=7,nt=8,ke=102,Se=16;function be(m,S,n,i){const w=i?new TextEncoder().encode(i):new Uint8Array(0),u=w.length,M=Se+u,x=new ArrayBuffer(M),f=new DataView(x),A=new Uint8Array(x);return f.setUint32(0,M,!1),f.setUint16(4,Se,!1),f.setUint16(6,m,!1),f.setUint32(8,S,!1),f.setUint32(12,n,!1),u>0&&A.set(w,Se),x}function at(m){const S=new DataView(m),n=S.getUint32(0,!1),i=S.getUint16(4,!1),w=S.getUint16(6,!1),u=S.getUint32(8,!1),M=S.getUint32(12,!1),x=n-i;let f;if(x>0){const A=new Uint8Array(m,i,x);f=new TextDecoder().decode(A)}return{ver:w,op:u,seq:M,body:f}}function ot(m){switch(m){case De:return"Heartbeat";case tt:return"Heartbeat Reply";case st:return"Message";case Ee:return"Auth";case nt:return"Auth Reply";default:return`Unknown(${m})`}}function rt(m){const S=B("disconnected"),n=B(null),i=B([]);let w=1,u=null,M=null;const x=(d,b)=>{if(!n.value||n.value.readyState!==WebSocket.OPEN)return;const g=JSON.stringify({mid:b,key:`user_${b}`,room_id:"",platform:"web",accepts:[1001,1002,1003]}),v=be(ke,Ee,w++,g);n.value.send(v),console.log("[WS] Auth sent")},f=()=>{if(!n.value||n.value.readyState!==WebSocket.OPEN)return;const d=be(ke,De,w++);n.value.send(d)},A=()=>{h(),u=window.setInterval(f,3e4)},h=()=>{u&&(clearInterval(u),u=null)},y=(d,b)=>{var g;if(((g=n.value)==null?void 0:g.readyState)!==WebSocket.OPEN){S.value="connecting";try{n.value=new WebSocket(m),n.value.binaryType="arraybuffer",n.value.onopen=()=>{console.log("[WS] Connected"),S.value="connected",x(d,b),A()},n.value.onmessage=v=>{const U=at(v.data);if(console.log("[WS] Received:",ot(U.op),U.seq,U.body),U.op===8)console.log("[WS] Auth success");else if(U.body)try{const W=JSON.parse(U.body);i.value.push(W)}catch{}},n.value.onclose=()=>{console.log("[WS] Disconnected"),S.value="disconnected",h(),M=window.setTimeout(()=>y(d,b),5e3)},n.value.onerror=v=>{console.error("[WS] Error:",v),S.value="error"}}catch(v){console.error("[WS] Connection error:",v),S.value="error"}}};return{status:S,messages:i,connect:y,disconnect:()=>{M&&(clearTimeout(M),M=null),h(),n.value&&(n.value.close(),n.value=null),S.value="disconnected"},send:(d,b)=>{if(!n.value||n.value.readyState!==WebSocket.OPEN)return console.error("[WS] Not connected"),!1;const g=be(ke,d,w++,b);return n.value.send(g),!0},sendHeartbeat:f,clearMessages:()=>{i.value=[]}}}const Y=m=>m?typeof m=="string"?m:typeof m=="object"&&"String"in m?m.Valid?m.String:"":String(m):"",lt={class:"conversation-list"},it=["onClick"],ct={class:"item-content"},ut={class:"item-top"},dt={class:"item-name"},mt={class:"item-time"},_t={class:"item-bottom"},vt={class:"item-preview"},pt=de({__name:"ConversationList",emits:["select"],setup(m,{emit:S}){const n=S,i=Be(),w=Ae(),u=J(()=>i.currentSession?`${i.currentSession.targetId}:${i.currentSession.targetType==="group"?2:1}`:""),M=s=>{var l,d;const t=Y((l=s.target_user)==null?void 0:l.nickname);if(t)return t;if(s.conversation_type===1){const b=i.friends.find(g=>{var v;return((v=g.friend_user)==null?void 0:v.id)===s.target_id||g.friend_id===s.target_id});if(b)return b.remark||Y((d=b.friend_user)==null?void 0:d.nickname)||`User ${s.target_id}`}if(s.conversation_type===2){const b=w.getGroupById(s.target_id);return b?b.name:`Group ${s.target_id}`}return`User ${s.target_id}`},x=s=>{var l,d;const t=Y((l=s.target_user)==null?void 0:l.avatar);if(t)return t;if(s.conversation_type===1){const b=i.friends.find(g=>{var v;return((v=g.friend_user)==null?void 0:v.id)===s.target_id||g.friend_id===s.target_id});if(b)return Y((d=b.friend_user)==null?void 0:d.avatar)}if(s.conversation_type===2){const b=w.getGroupById(s.target_id);if(b)return Y(b.avatar)}return""},f=s=>{const t=Y(s.last_msg_content);if(!t)return"暂无消息";try{return JSON.parse(t).text||t}catch{return t}},A=s=>{if(!s)return"";const t=new Date(s);if(isNaN(t.getTime())){if(typeof s=="string"&&!isNaN(Number(s))){const l=Number(s),d=new Date(l<1e10?l*1e3:l);if(!isNaN(d.getTime()))return h(d)}return""}return h(t)},h=s=>{const t=new Date;return s.getDate()===t.getDate()&&s.getMonth()===t.getMonth()&&s.getFullYear()===t.getFullYear()?s.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):s.toLocaleDateString("zh-CN",{month:"numeric",day:"numeric"})},y=s=>{n("select",s)};return(s,t)=>{const l=$("el-avatar"),d=$("el-badge"),b=$("el-empty");return k(),V("div",lt,[(k(!0),V(oe,null,re(F(i).conversations,g=>(k(),V("div",{key:`${g.target_id}:${g.conversation_type}`,class:ee(["list-item",{active:u.value===`${g.target_id}:${g.conversation_type}`}]),onClick:v=>y(g)},[e(l,{size:48,src:x(g),shape:"square",class:"item-avatar"},{default:o(()=>{var v;return[E(N(((v=M(g))==null?void 0:v[0])||"?"),1)]}),_:2},1032,["src"]),a("div",ct,[a("div",ut,[a("span",dt,N(M(g)),1),a("span",mt,N(A(g.last_msg_time)),1)]),a("div",_t,[a("span",vt,N(f(g)),1),g.unread_count>0?(k(),L(d,{key:0,value:g.unread_count>99?"99+":g.unread_count,class:"unread-badge"},null,8,["value"])):O("",!0)])])],10,it))),128)),F(i).conversations.length===0?(k(),L(b,{key:0,description:"暂无消息","image-size":60})):O("",!0)])}}}),ft=me(pt,[["__scopeId","data-v-2695438a"]]),gt={class:"friend-manager-container"},yt={class:"friend-list-content"},ht={class:"list-header"},wt={class:"friend-items"},kt=["onClick"],St={class:"friend-info"},bt={class:"friend-name"},Ct={class:"friend-meta"},$t={key:0,class:"friend-nickname"},Mt={class:"friend-group"},Bt={class:"requests-content"},At={class:"request-items"},xt={class:"request-info"},Ut={class:"request-name"},Ft={key:0,class:"request-message"},Vt={class:"request-time"},Nt={class:"request-actions"},Tt={class:"add-friend-content"},Gt={key:0,class:"search-results"},zt={class:"user-info"},Dt={class:"user-name"},Et={class:"user-username"},It={class:"target-user"},Rt=de({__name:"FriendManager",setup(m){const S=Be(),n=B("list"),i=B(""),w=B({keyword:""}),u=B([]),M=B(!1),x=B([]),f=B(!1),A=B({remark:"",groupName:""}),h=B(null),y=B(!1),s=B({message:""}),t=B(null),l=J(()=>{if(!i.value)return S.friends;const C=i.value.toLowerCase();return S.friends.filter(r=>{var ie,c;const z=Y((ie=r.friend_user)==null?void 0:ie.nickname).toLowerCase(),I=((c=r.remark)==null?void 0:c.toLowerCase())||"";return z.includes(C)||I.includes(C)})}),d=C=>Y(C==null?void 0:C.nickname),b=C=>{const r=new Date(C),I=new Date().getTime()-r.getTime();return I<6e4?"刚刚":I<36e5?`${Math.floor(I/6e4)} 分钟前`:I<864e5?`${Math.floor(I/36e5)} 小时前`:I<6048e5?`${Math.floor(I/864e5)} 天前`:r.toLocaleDateString("zh-CN")},g=()=>{},v=C=>{var z;const r=((z=C.friend_user)==null?void 0:z.id)||C.friend_id;S.openChat(r,1,C.remark||d(C.friend_user)||C.remark)},U=async(C,r)=>{var z;switch(C){case"chat":v(r);break;case"remark":h.value=r,A.value={remark:r.remark||((z=r.friend_user)==null?void 0:z.nickname)||"",groupName:r.group_name||""},f.value=!0;break;case"delete":await Q(r);break}},W=async()=>{if(h.value)try{j.success("备注已更新"),f.value=!1,await S.loadFriends()}catch(C){j.error(C.message||"更新失败")}},Q=async C=>{var r;try{await Te.confirm(`确定要删除好友 "${C.remark||((r=C.friend_user)==null?void 0:r.nickname)}" 吗？`,"删除好友",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await ue.deleteFriend(C.id)).code===0&&(j.success("已删除好友"),await S.loadFriends())}catch(z){z!=="cancel"&&j.error(z.message||"删除失败")}},te=async()=>{if(w.value.keyword.trim()){M.value=!0;try{const C=await Re.searchUsers(w.value.keyword);C.code===0&&(u.value=C.data.users||[])}catch(C){j.error(C.message||"搜索失败")}}},D=C=>{t.value=C,s.value.message="",y.value=!0},se=async()=>{if(t.value)try{(await ue.sendRequest({to_user_id:t.value.id,message:s.value.message})).code===0&&(j.success("好友请求已发送"),y.value=!1,u.value=[])}catch(C){j.error(C.message||"发送失败")}},le=async(C,r)=>{try{(await(r==="accept"?ue.acceptRequest:ue.rejectRequest)(C)).code===0&&(j.success(r==="accept"?"已接受好友请求":"已拒绝好友请求"),await G(),r==="accept"&&await S.loadFriends())}catch(z){j.error(z.message||"操作失败")}},G=async()=>{try{const C=await ue.getRequests();C.code===0&&(x.value=(C.data.requests||[]).filter(r=>r.status===0))}catch(C){console.error("Failed to load friend requests:",C)}};return ge(async()=>{await S.loadFriends(),await G()}),(C,r)=>{const z=$("el-input"),I=$("el-avatar"),ie=$("MoreFilled"),c=$("el-icon"),_=$("el-button"),T=$("el-dropdown-item"),q=$("el-dropdown-menu"),H=$("el-dropdown"),R=$("el-empty"),Z=$("el-tab-pane"),we=$("el-badge"),ne=$("el-form-item"),ce=$("el-form"),P=$("el-tabs"),_e=$("el-dialog");return k(),V("div",gt,[e(P,{modelValue:n.value,"onUpdate:modelValue":r[2]||(r[2]=p=>n.value=p),class:"friend-tabs"},{default:o(()=>[e(Z,{label:"好友列表",name:"list"},{default:o(()=>[a("div",yt,[a("div",ht,[e(z,{modelValue:i.value,"onUpdate:modelValue":r[0]||(r[0]=p=>i.value=p),placeholder:"搜索好友","prefix-icon":F(Fe),clearable:"",onInput:g},null,8,["modelValue","prefix-icon"])]),a("div",wt,[(k(!0),V(oe,null,re(l.value,p=>{var K,ae,X,ve;return k(),V("div",{key:p.id,class:"friend-item"},[a("div",{class:"friend-main",onClick:pe=>v(p)},[e(I,{size:48,src:(K=p.friend_user)==null?void 0:K.avatar},{default:o(()=>{var pe,xe;return[E(N(((xe=(pe=p.friend_user)==null?void 0:pe.nickname)==null?void 0:xe[0])||"?"),1)]}),_:2},1032,["src"]),a("div",St,[a("div",bt,N(p.remark||((ae=p.friend_user)==null?void 0:ae.nickname)),1),a("div",Ct,[p.remark!==((X=p.friend_user)==null?void 0:X.nickname)?(k(),V("span",$t," 昵称: "+N((ve=p.friend_user)==null?void 0:ve.nickname),1)):O("",!0),a("span",Mt,N(p.group_name||"默认分组"),1)])])],8,kt),e(H,{trigger:"click",onCommand:pe=>U(pe,p)},{dropdown:o(()=>[e(q,null,{default:o(()=>[e(T,{command:"chat"},{default:o(()=>[...r[10]||(r[10]=[E("发消息",-1)])]),_:1}),e(T,{command:"remark"},{default:o(()=>[...r[11]||(r[11]=[E("设置备注",-1)])]),_:1}),e(T,{command:"delete",divided:""},{default:o(()=>[...r[12]||(r[12]=[E("删除好友",-1)])]),_:1})]),_:1})]),default:o(()=>[e(_,{text:"",circle:""},{default:o(()=>[e(c,null,{default:o(()=>[e(ie)]),_:1})]),_:1})]),_:1},8,["onCommand"])])}),128)),l.value.length===0?(k(),L(R,{key:0,description:"暂无好友"})):O("",!0)])])]),_:1}),e(Z,{name:"requests"},{label:o(()=>[r[13]||(r[13]=a("span",null,"好友请求",-1)),x.value.length>0?(k(),L(we,{key:0,value:x.value.length,class:"request-badge"},null,8,["value"])):O("",!0)]),default:o(()=>[a("div",Bt,[a("div",At,[(k(!0),V(oe,null,re(x.value,p=>{var K,ae;return k(),V("div",{key:p.id,class:"request-item"},[e(I,{size:48,src:(K=p.from_user)==null?void 0:K.avatar},{default:o(()=>{var X,ve;return[E(N(((ve=(X=p.from_user)==null?void 0:X.nickname)==null?void 0:ve[0])||"?"),1)]}),_:2},1032,["src"]),a("div",xt,[a("div",Ut,N((ae=p.from_user)==null?void 0:ae.nickname),1),p.message?(k(),V("div",Ft,N(p.message),1)):O("",!0),a("div",Vt,N(b(p.created_at)),1)]),a("div",Nt,[e(_,{type:"primary",size:"small",onClick:X=>le(p.id,"accept")},{default:o(()=>[...r[14]||(r[14]=[E(" 接受 ",-1)])]),_:1},8,["onClick"]),e(_,{size:"small",onClick:X=>le(p.id,"reject")},{default:o(()=>[...r[15]||(r[15]=[E(" 拒绝 ",-1)])]),_:1},8,["onClick"])])])}),128)),x.value.length===0?(k(),L(R,{key:0,description:"暂无好友请求"})):O("",!0)])])]),_:1}),e(Z,{label:"添加好友",name:"add"},{default:o(()=>[a("div",Tt,[e(ce,{model:w.value,"label-position":"top"},{default:o(()=>[e(ne,{label:"搜索用户"},{default:o(()=>[e(z,{modelValue:w.value.keyword,"onUpdate:modelValue":r[1]||(r[1]=p=>w.value.keyword=p),placeholder:"输入用户名或昵称",onKeyup:Ne(te,["enter"])},{append:o(()=>[e(_,{icon:F(Fe),onClick:te},null,8,["icon"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"]),u.value.length>0?(k(),V("div",Gt,[r[17]||(r[17]=a("div",{class:"results-title"},"搜索结果",-1)),(k(!0),V(oe,null,re(u.value,p=>(k(),V("div",{key:p.id,class:"user-item"},[e(I,{size:40,src:p.avatar},{default:o(()=>{var K;return[E(N(((K=p.nickname)==null?void 0:K[0])||"?"),1)]}),_:2},1032,["src"]),a("div",zt,[a("div",Dt,N(p.nickname),1),a("div",Et,"@"+N(p.username),1)]),e(_,{type:"primary",size:"small",onClick:K=>D(p)},{default:o(()=>[...r[16]||(r[16]=[E(" 添加 ",-1)])]),_:1},8,["onClick"])]))),128))])):M.value&&u.value.length===0?(k(),L(R,{key:1,description:"未找到用户"})):(k(),L(R,{key:2,description:"搜索用户来添加好友"}))])]),_:1})]),_:1},8,["modelValue"]),e(_e,{modelValue:f.value,"onUpdate:modelValue":r[6]||(r[6]=p=>f.value=p),title:"设置备注",width:"400px"},{footer:o(()=>[e(_,{onClick:r[5]||(r[5]=p=>f.value=!1)},{default:o(()=>[...r[18]||(r[18]=[E("取消",-1)])]),_:1}),e(_,{type:"primary",onClick:W},{default:o(()=>[...r[19]||(r[19]=[E("保存",-1)])]),_:1})]),default:o(()=>[e(ce,{model:A.value,"label-width":"80px"},{default:o(()=>[e(ne,{label:"备注名"},{default:o(()=>[e(z,{modelValue:A.value.remark,"onUpdate:modelValue":r[3]||(r[3]=p=>A.value.remark=p),placeholder:"请输入备注名",maxlength:"50"},null,8,["modelValue"])]),_:1}),e(ne,{label:"分组"},{default:o(()=>[e(z,{modelValue:A.value.groupName,"onUpdate:modelValue":r[4]||(r[4]=p=>A.value.groupName=p),placeholder:"请输入分组名"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),e(_e,{modelValue:y.value,"onUpdate:modelValue":r[9]||(r[9]=p=>y.value=p),title:"添加好友",width:"400px"},{footer:o(()=>[e(_,{onClick:r[8]||(r[8]=p=>y.value=!1)},{default:o(()=>[...r[20]||(r[20]=[E("取消",-1)])]),_:1}),e(_,{type:"primary",onClick:se},{default:o(()=>[...r[21]||(r[21]=[E("发送请求",-1)])]),_:1})]),default:o(()=>[e(ce,{model:s.value,"label-width":"80px"},{default:o(()=>[e(ne,{label:"对方"},{default:o(()=>{var p,K;return[a("div",It,[e(I,{size:32,src:(p=t.value)==null?void 0:p.avatar},{default:o(()=>{var ae,X;return[E(N((X=(ae=t.value)==null?void 0:ae.nickname)==null?void 0:X[0]),1)]}),_:1},8,["src"]),a("span",null,N((K=t.value)==null?void 0:K.nickname),1)])]}),_:1}),e(ne,{label:"验证消息"},{default:o(()=>[e(z,{modelValue:s.value.message,"onUpdate:modelValue":r[7]||(r[7]=p=>s.value.message=p),type:"textarea",rows:3,placeholder:"请输入验证消息（可选）",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Lt=me(Rt,[["__scopeId","data-v-c52824cc"]]),qt={class:"group-list-container"},Ot={class:"list-header"},Wt={class:"group-list"},Pt=["onClick"],Ht={class:"item-content"},Kt={class:"item-name"},jt={class:"item-meta"},Jt=de({__name:"GroupList",emits:["select"],setup(m,{emit:S}){const n=S,i=Ae(),w=B(!1),u=B({name:"",max_members:100}),M=J(()=>{var y;return(y=i.currentGroup)==null?void 0:y.id}),x={},f=y=>{if(!x[y]){const s=["#F56C6C","#E6A23C","#67C23A","#409EFF","#909399"];x[y]=s[y%s.length]}return x[y]},A=y=>{n("select",y)},h=async()=>{if(u.value.name.trim())try{const y=await i.createGroup({name:u.value.name,max_members:u.value.max_members});y&&(j.success("群组创建成功"),w.value=!1,u.value.name="",u.value.max_members=100,A(y))}catch(y){j.error(y.message||"创建失败")}};return ge(()=>{i.groups.length||i.loadGroups()}),(y,s)=>{const t=$("el-icon"),l=$("el-button"),d=$("el-skeleton"),b=$("el-avatar"),g=$("el-empty"),v=$("el-input"),U=$("el-form-item"),W=$("el-input-number"),Q=$("el-form"),te=$("el-dialog");return k(),V("div",qt,[a("div",Ot,[s[5]||(s[5]=a("div",{class:"list-title"},"我的群组",-1)),e(l,{type:"primary",size:"small",circle:"",onClick:s[0]||(s[0]=D=>w.value=!0)},{default:o(()=>[e(t,null,{default:o(()=>[e(F(Le))]),_:1})]),_:1})]),a("div",Wt,[F(i).loading?(k(),L(d,{key:0,rows:3,animated:"",class:"p-4"})):F(i).groups&&F(i).groups.length>0?(k(!0),V(oe,{key:1},re(F(i).groups.filter(D=>D!=null),D=>(k(),V("div",{key:D.id,class:ee(["list-item",{active:M.value===D.id}]),onClick:se=>A(D)},[e(b,{size:48,style:he({backgroundColor:f(D.id)}),shape:"square",class:"item-avatar"},{default:o(()=>[e(t,{size:"24",color:"white"},{default:o(()=>[e(F(Me))]),_:1})]),_:1},8,["style"]),a("div",Ht,[a("div",Kt,N(D.name),1),a("div",jt,N(D.member_count)+" 成员",1)])],10,Pt))),128)):(k(),L(g,{key:2,description:"暂无群组","image-size":60}))]),e(te,{modelValue:w.value,"onUpdate:modelValue":s[4]||(s[4]=D=>w.value=D),title:"创建群组",width:"400px","append-to-body":""},{footer:o(()=>[e(l,{onClick:s[3]||(s[3]=D=>w.value=!1)},{default:o(()=>[...s[6]||(s[6]=[E("取消",-1)])]),_:1}),e(l,{type:"primary",onClick:h,disabled:!u.value.name.trim()},{default:o(()=>[...s[7]||(s[7]=[E(" 创建 ",-1)])]),_:1},8,["disabled"])]),default:o(()=>[e(Q,{model:u.value,"label-width":"80px"},{default:o(()=>[e(U,{label:"群名称"},{default:o(()=>[e(v,{modelValue:u.value.name,"onUpdate:modelValue":s[1]||(s[1]=D=>u.value.name=D),placeholder:"请输入群名称",maxlength:"50"},null,8,["modelValue"])]),_:1}),e(U,{label:"群人数"},{default:o(()=>[e(W,{modelValue:u.value.max_members,"onUpdate:modelValue":s[2]||(s[2]=D=>u.value.max_members=D),min:2,max:500},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Yt=me(Jt,[["__scopeId","data-v-6c4a1f54"]]),Qt={class:"bot-list-container"},Xt={class:"bot-list"},Zt=["onClick"],es={class:"item-content"},ts={class:"item-name"},ss={class:"item-desc"},ns=de({__name:"BotList",emits:["select"],setup(m,{emit:S}){const n=S,i=ze(),w=J(()=>{var A;return(A=i.currentBot)==null?void 0:A.id}),u={9001:"#409EFF",9002:"#67C23A",9003:"#E6A23C",9004:"#F56C6C"},M=A=>u[A]||"#909399",x=A=>({assistant:"智能助手",companion:"聊天伙伴",tutor:"学习导师",creative:"创意助手"})[A]||"AI 助手",f=A=>{n("select",A)};return ge(()=>{i.bots.length||i.loadBots()}),(A,h)=>{const y=$("el-icon"),s=$("el-avatar");return k(),V("div",Qt,[h[0]||(h[0]=a("div",{class:"list-header"},[a("div",{class:"list-title"},"AI 助手")],-1)),a("div",Xt,[(k(!0),V(oe,null,re(F(i).bots,t=>(k(),V("div",{key:t.id,class:ee(["list-item",{active:w.value===t.id}]),onClick:l=>f(t)},[e(s,{size:48,style:he({backgroundColor:M(t.id)}),shape:"square",class:"item-avatar"},{default:o(()=>[e(y,{size:"24",color:"white"},{default:o(()=>[e(F(Me))]),_:1})]),_:1},8,["style"]),a("div",es,[a("div",ts,N(t.name),1),a("div",ss,N(x(t.personality)),1)])],10,Zt))),128))])])}}}),as=me(ns,[["__scopeId","data-v-9e51ef78"]]),os={class:"chat-window"},rs={class:"chat-header"},ls={class:"header-left"},is={class:"header-info"},cs={class:"header-title"},us={key:0,class:"header-subtitle"},ds={class:"header-actions"},ms={key:0,class:"loading-state"},_s={key:0,class:"message-time-divider"},vs={class:"message-row"},ps={class:"message-content-group"},fs={key:0,class:"message-sender-name"},gs={key:0,class:"typing-indicator"},ys={key:1,class:"message-text"},hs={key:2,class:"empty-state"},ws={class:"input-area"},ks={class:"input-toolbar"},Ss={class:"input-footer"},bs=de({__name:"ChatWindow",props:{messages:{},currentUserId:{},title:{},subtitle:{},avatar:{},avatarStyle:{},sending:{type:Boolean},loading:{type:Boolean},showSenderName:{type:Boolean},getSenderName:{type:Function},getSenderAvatar:{type:Function},getSenderStyle:{type:Function}},emits:["send"],setup(m,{emit:S}){const n=m,i=S,w=B(""),u=B(),M=v=>v.from_user_id===n.currentUserId||v.role==="user",x=v=>{const U=Y(v);if(!U)return"";try{return JSON.parse(U).text||U}catch{return U}},f=(v,U)=>{if(!U)return!0;const W=new Date(v.timestamp||v.created_at).getTime(),Q=new Date(U.timestamp||U.created_at).getTime();return W-Q>5*60*1e3},A=v=>v?new Date(typeof v=="string"&&v.length<13?parseInt(v)*1e3:v).toLocaleString("zh-CN",{hour:"2-digit",minute:"2-digit",month:"short",day:"numeric"}):"",h=()=>{!w.value.trim()||n.sending||(i("send",w.value),w.value="")},y=()=>{Oe(()=>{u.value&&(u.value.scrollTop=u.value.scrollHeight)})};Ge(()=>n.messages,()=>{y()},{deep:!0}),ge(()=>{y()});const s=v=>v.senderName||"User",t=v=>v.senderAvatar||"",l=v=>({}),d=n.getSenderName||s,b=n.getSenderAvatar||t,g=n.getSenderStyle||l;return(v,U)=>{const W=$("el-icon"),Q=$("el-avatar"),te=$("el-skeleton"),D=$("el-empty"),se=$("el-button"),le=$("el-input");return k(),V("div",os,[a("div",rs,[a("div",ls,[Ve(v.$slots,"header-prefix",{},void 0,!0),e(Q,{size:40,src:m.avatar,style:he(m.avatarStyle)},{default:o(()=>{var G;return[E(N(((G=m.title)==null?void 0:G[0])||"?")+" ",1),!m.title&&!m.avatar?(k(),L(W,{key:0},{default:o(()=>[e(F(We))]),_:1})):O("",!0)]}),_:1},8,["src","style"]),a("div",is,[a("div",cs,N(m.title),1),m.subtitle?(k(),V("div",us,N(m.subtitle),1)):O("",!0)])]),a("div",ds,[Ve(v.$slots,"actions",{},void 0,!0)])]),a("div",{class:"messages-container",ref_key:"messagesRef",ref:u},[m.loading?(k(),V("div",ms,[e(te,{rows:3,animated:""})])):(k(!0),V(oe,{key:1},re(m.messages,(G,C)=>(k(),V("div",{key:G.id||C,class:ee(["message-wrapper",{"is-me":M(G)}])},[f(G,m.messages[C-1])?(k(),V("div",_s,[a("span",null,N(A(G.timestamp||G.created_at)),1)])):O("",!0),a("div",vs,[e(Q,{class:"message-avatar",size:36,src:F(b)(G),style:he(F(g)(G))},{default:o(()=>{var r;return[E(N(((r=F(d)(G))==null?void 0:r[0])||"?"),1)]}),_:2},1032,["src","style"]),a("div",ps,[!M(G)&&m.showSenderName?(k(),V("div",fs,N(F(d)(G)),1)):O("",!0),a("div",{class:ee(["message-bubble",{typing:G.isTyping}])},[G.isTyping?(k(),V("div",gs,[...U[1]||(U[1]=[a("span",null,null,-1),a("span",null,null,-1),a("span",null,null,-1)])])):(k(),V("div",ys,N(x(G.content)),1))],2)])])],2))),128)),m.messages.length===0&&!m.loading?(k(),V("div",hs,[e(D,{description:"暂无消息"})])):O("",!0)],512),a("div",ws,[a("div",ks,[e(se,{text:"",circle:"",size:"small"},{default:o(()=>[e(W,null,{default:o(()=>[e(F(Pe))]),_:1})]),_:1}),e(se,{text:"",circle:"",size:"small"},{default:o(()=>[e(W,null,{default:o(()=>[e(F(He))]),_:1})]),_:1})]),e(le,{modelValue:w.value,"onUpdate:modelValue":U[0]||(U[0]=G=>w.value=G),type:"textarea",rows:3,placeholder:"输入消息...",resize:"none",onKeydown:Ne(qe(h,["exact","prevent"]),["enter"]),class:"chat-input"},null,8,["modelValue","onKeydown"]),a("div",Ss,[U[3]||(U[3]=a("span",{class:"input-hint"},"Enter 发送，Shift + Enter 换行",-1)),e(se,{type:"primary",onClick:h,disabled:!w.value.trim()||m.sending,loading:m.sending},{default:o(()=>[...U[2]||(U[2]=[E(" 发送 ",-1)])]),_:1},8,["disabled","loading"])])])])}}}),Cs=me(bs,[["__scopeId","data-v-2a4921c5"]]),$s={class:"main-layout"},Ms={class:"icon-sidebar"},Bs={class:"app-logo"},As={class:"nav-items"},xs={class:"bottom-actions"},Us={class:"user-dropdown-header"},Fs={class:"dropdown-name"},Vs={class:"list-sidebar"},Ns={class:"sidebar-search"},Ts={class:"sidebar-content"},Gs={class:"main-content"},zs={key:1,class:"empty-state"},Ds=de({__name:"Main",setup(m){const S=et(),n=Ce(),i=Be(),w=Ae(),u=ze(),M=B("chats"),x=B(""),f=B(null),{messages:A,connect:h,disconnect:y}=rt("ws://localhost:3102/sub"),s=J(()=>{var c;return f.value==="ai"?u.currentBot?u.getBotMessages(u.currentBot.id):[]:((c=i.currentSession)==null?void 0:c.messages)||[]}),t=J(()=>{var c,_;return f.value==="ai"?((c=u.currentBot)==null?void 0:c.name)||"AI":((_=i.currentSession)==null?void 0:_.name)||"Chat"}),l=J(()=>{var c;return f.value==="ai"?((c=u.currentBot)==null?void 0:c.personality)||"Assistant":f.value==="group"?`${w.members.length} members`:"Online"}),d=J(()=>{var c;return f.value==="ai"?"":(c=i.currentSession)==null?void 0:c.avatar}),b=J(()=>{var c;if(f.value==="ai"&&u.currentBot)return{backgroundColor:{9001:"#409EFF",9002:"#67C23A",9003:"#E6A23C",9004:"#F56C6C"}[u.currentBot.id]||"#909399"};if(f.value==="group"){const _=["#F56C6C","#E6A23C","#67C23A","#409EFF","#909399"],T=((c=i.currentSession)==null?void 0:c.targetId)||0;return{backgroundColor:_[T%_.length]}}return{}}),g=J(()=>f.value==="ai"?u.sending:!1),v=J(()=>!1),U=async c=>{var q,H;f.value=c.conversation_type===2?"group":"private";const _=Y((q=c.target_user)==null?void 0:q.nickname),T=Y((H=c.target_user)==null?void 0:H.avatar);await i.openChat(c.target_id,c.conversation_type,_,T),f.value==="group"&&await r(c.target_id)},W=c=>{var T,q;const _=((T=c.friend_user)==null?void 0:T.id)||c.friend_id;f.value="private",i.openChat(_,1,c.remark||((q=c.friend_user)==null?void 0:q.nickname)),M.value="chats"},Q=async c=>{f.value="group",await w.setCurrentGroup(c),i.openChat(c.id,2,c.name),await r(c.id)},te=c=>{f.value="ai",u.setCurrentBot(c)},D=async c=>{if(f.value==="ai")u.currentBot&&await u.sendMessage(u.currentBot.id,c);else{const _=f.value==="group"?2:1;await i.sendMessage(JSON.stringify({text:c}),_)}},se=async()=>{try{await Te.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),y(),n.logout(),S.push("/login")}catch{}},le=()=>{j.info("查看群成员功能待实现 (Refactored)")},G=async()=>{u.currentBot&&u.clearMessages(u.currentBot.id)},C=B(new Map),r=async c=>{C.value.has(c)||await w.loadGroups()},z=c=>{var _,T,q,H;if(c.role)return c.role==="user"?"我":((_=u.currentBot)==null?void 0:_.name)||"AI";if(c.from_user_id===((T=n.currentUser)==null?void 0:T.id))return"我";if(f.value==="group"){const R=w.members.find(Z=>Z.user_id===c.from_user_id);return((q=R==null?void 0:R.user)==null?void 0:q.nickname)||(R==null?void 0:R.nickname)||`User ${c.from_user_id}`}return((H=i.currentSession)==null?void 0:H.name)||"User"},I=c=>{var _,T,q,H;if(c.role==="assistant")return"";if(c.from_user_id===((_=n.currentUser)==null?void 0:_.id))return((T=n.currentUser)==null?void 0:T.avatar)||"";if(f.value==="group"){const R=w.members.find(Z=>Z.user_id===c.from_user_id);return((q=R==null?void 0:R.user)==null?void 0:q.avatar)||""}return((H=i.currentSession)==null?void 0:H.avatar)||""},ie=c=>c.role==="assistant"&&u.currentBot?b.value:{};return ge(async()=>{if(n.isLoggedIn){await Promise.all([i.loadConversations(),i.loadFriends()]);try{h(n.token,n.currentUser.id)}catch(c){console.warn("WS failed",c)}}}),Ge(A,c=>{if(c.length>0){const _=c[c.length-1];(_.conversation_type===1||_.conversation_type===2)&&i.addMessage({id:Date.now(),msg_id:_.msg_id,from_user_id:_.from_user_id,conversation_id:_.conversation_id,conversation_type:_.conversation_type,msg_type:_.msg_type,content:_.content,seq:_.seq,created_at:new Date(_.created_at).toISOString()})}}),(c,_)=>{var ce;const T=$("el-icon"),q=$("el-avatar"),H=$("el-dropdown-item"),R=$("el-dropdown-menu"),Z=$("el-dropdown"),we=$("el-input"),ne=$("el-button");return k(),V("div",$s,[a("div",Ms,[a("div",Bs,[e(T,{size:32,color:"#6366f1"},{default:o(()=>[e(F(Me))]),_:1})]),a("div",As,[a("div",{class:ee(["nav-item",{active:M.value==="chats"}]),onClick:_[0]||(_[0]=P=>M.value="chats"),title:"聊天"},[e(T,{size:24},{default:o(()=>[e(F(Ke))]),_:1})],2),a("div",{class:ee(["nav-item",{active:M.value==="friends"}]),onClick:_[1]||(_[1]=P=>M.value="friends"),title:"好友"},[e(T,{size:24},{default:o(()=>[e(F(je))]),_:1})],2),a("div",{class:ee(["nav-item",{active:M.value==="groups"}]),onClick:_[2]||(_[2]=P=>M.value="groups"),title:"群组"},[e(T,{size:24},{default:o(()=>[e(F(Je))]),_:1})],2),a("div",{class:ee(["nav-item",{active:M.value==="ai"}]),onClick:_[3]||(_[3]=P=>M.value="ai"),title:"AI 助手"},[e(T,{size:24},{default:o(()=>[e(F(Ye))]),_:1})],2)]),a("div",xs,[e(Z,{trigger:"click",placement:"right-end"},{dropdown:o(()=>[e(R,null,{default:o(()=>{var P;return[a("div",Us,[a("div",Fs,N((P=F(n).currentUser)==null?void 0:P.nickname),1),_[5]||(_[5]=a("div",{class:"dropdown-status"},"在线",-1))]),e(H,{divided:"",onClick:se},{default:o(()=>[e(T,null,{default:o(()=>[e(F(Qe))]),_:1}),_[6]||(_[6]=E("退出登录 ",-1))]),_:1})]}),_:1})]),default:o(()=>{var P;return[e(q,{size:40,src:(P=F(n).currentUser)==null?void 0:P.avatar,class:"user-avatar"},{default:o(()=>{var _e,p;return[E(N((p=(_e=F(n).currentUser)==null?void 0:_e.nickname)==null?void 0:p[0]),1)]}),_:1},8,["src"])]}),_:1})])]),a("div",Vs,[a("div",Ns,[e(we,{modelValue:x.value,"onUpdate:modelValue":_[4]||(_[4]=P=>x.value=P),placeholder:"搜索...","prefix-icon":"Search",class:"custom-input"},null,8,["modelValue"])]),a("div",Ts,[M.value==="chats"?(k(),L(ft,{key:0,onSelect:U})):M.value==="friends"?(k(),L(Lt,{key:1,onChat:W})):M.value==="groups"?(k(),L(Yt,{key:2,onSelect:Q})):M.value==="ai"?(k(),L(as,{key:3,onSelect:te})):O("",!0)])]),a("div",Gs,[f.value?(k(),L(Cs,{key:0,messages:s.value,"current-user-id":((ce=F(n).currentUser)==null?void 0:ce.id)||0,title:t.value,subtitle:l.value,avatar:d.value,"avatar-style":b.value,sending:g.value,loading:v.value,"show-sender-name":f.value==="group","get-sender-name":z,"get-sender-avatar":I,"get-sender-style":ie,onSend:D},{actions:o(()=>[f.value==="group"?(k(),L(ne,{key:0,text:"",circle:"",onClick:le},{default:o(()=>[e(T,null,{default:o(()=>[e(F(Xe))]),_:1})]),_:1})):O("",!0),f.value==="ai"?(k(),L(ne,{key:1,text:"",circle:"",onClick:G},{default:o(()=>[e(T,null,{default:o(()=>[e(F(Ze))]),_:1})]),_:1})):O("",!0)]),_:1},8,["messages","current-user-id","title","subtitle","avatar","avatar-style","sending","loading","show-sender-name"])):(k(),V("div",zs,[..._[7]||(_[7]=[a("div",{class:"empty-content"},[a("img",{src:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?prompt=minimalist%20chat%20illustration%20vector%20flat%20design%20blue&image_size=square_hd",alt:"Empty State",class:"empty-img"}),a("h3",null,"开始聊天"),a("p",null,"选择一个联系人或群组开始对话")],-1)])]))])])}}}),Is=me(Ds,[["__scopeId","data-v-587b586b"]]);export{Is as default};
